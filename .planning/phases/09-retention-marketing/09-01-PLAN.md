---
phase: 09-retention-marketing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/004_add_email_preferences.sql
  - src/types/database.ts
  - src/types/email-preferences.ts
  - src/app/api/webhook/route.ts
autonomous: true
user_setup:
  - service: resend
    why: "Email delivery for anniversary reminders"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys -> Create API Key"
      - name: COMPANY_ADDRESS
        source: "Physical postal address for CAN-SPAM compliance in email footer"

must_haves:
  truths:
    - "email_preferences table exists with global_unsubscribe, occasion_unsubscribes, and unsubscribe_token columns"
    - "Email preference record is automatically created when a user places their first order"
    - "TypeScript types exist for email_preferences table matching the database schema"
  artifacts:
    - path: "supabase/migrations/004_add_email_preferences.sql"
      provides: "email_preferences table with RLS policies"
      contains: "CREATE TABLE email_preferences"
    - path: "src/types/email-preferences.ts"
      provides: "EmailPreferences TypeScript interface and related types"
      exports: ["EmailPreferences", "OccasionReminder"]
    - path: "src/types/database.ts"
      provides: "Updated Database type including email_preferences table"
      contains: "email_preferences"
    - path: "src/app/api/webhook/route.ts"
      provides: "Webhook creates email_preferences on first base order"
      contains: "email_preferences"
  key_links:
    - from: "src/app/api/webhook/route.ts"
      to: "email_preferences table"
      via: "Supabase insert in checkout.session.completed handler"
      pattern: "email_preferences.*insert"
---

<objective>
Create the email_preferences database table, TypeScript types, and wire preference record creation into the existing order webhook -- the data foundation for anniversary reminders and unsubscribe controls.

Purpose: RETAIN-01 (store occasion info) is already partially satisfied by the existing occasion_date column on orders. This plan adds the missing email preference infrastructure (RETAIN-04 foundation) and ensures preference records exist for every paying user.
Output: Migration SQL, TypeScript types, updated webhook handler.
</objective>

<execution_context>
@/Users/jamesshallcrass/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamesshallcrass/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-retention-marketing/09-RESEARCH.md
@src/types/database.ts
@src/app/api/webhook/route.ts
@src/lib/supabase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Email preferences migration and TypeScript types</name>
  <files>
    supabase/migrations/004_add_email_preferences.sql
    src/types/email-preferences.ts
    src/types/database.ts
  </files>
  <action>
    1. Create `supabase/migrations/004_add_email_preferences.sql`:
       - CREATE TABLE email_preferences with columns:
         - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
         - user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE
         - global_unsubscribe BOOLEAN DEFAULT false
         - occasion_unsubscribes UUID[] DEFAULT '{}' (array of order IDs the user has opted out of)
         - unsubscribe_token TEXT UNIQUE NOT NULL (secure random token for URL-based unsubscribe)
         - created_at TIMESTAMPTZ DEFAULT NOW()
         - updated_at TIMESTAMPTZ DEFAULT NOW()
         - UNIQUE(user_id) constraint
       - CREATE INDEX idx_email_prefs_user ON email_preferences(user_id)
       - CREATE INDEX idx_email_prefs_token ON email_preferences(unsubscribe_token)
       - Enable RLS on email_preferences
       - RLS policy: "Users can view own preferences" FOR SELECT TO authenticated USING (auth.uid() = user_id)
       - RLS policy: "Users can update own preferences" FOR UPDATE TO authenticated USING (auth.uid() = user_id)
       - RLS policy: "Service role can manage preferences" FOR ALL TO service_role USING (true)

    2. Create `src/types/email-preferences.ts`:
       - Export EmailPreferences interface matching the table schema (id, userId, globalUnsubscribe, occasionUnsubscribes, unsubscribeToken, createdAt, updatedAt)
       - Export OccasionReminder interface: { orderId, userId, occasionDate, occasionType, recipientName, userEmail }
       - Export type UnsubscribeAction = 'global' | 'occasion'

    3. Update `src/types/database.ts`:
       - Add email_preferences table definition to the Database interface following existing pattern (Row, Insert, Update)
       - Row fields: id (string), user_id (string), global_unsubscribe (boolean), occasion_unsubscribes (string[]), unsubscribe_token (string), created_at (string), updated_at (string)
  </action>
  <verify>
    - File exists: supabase/migrations/004_add_email_preferences.sql
    - File exists: src/types/email-preferences.ts
    - src/types/database.ts contains email_preferences table definition
    - `npx tsc --noEmit` passes (no type errors)
  </verify>
  <done>
    Migration SQL defines email_preferences table with correct schema, indexes, and RLS policies. TypeScript types for EmailPreferences and OccasionReminder are exported. Database interface includes email_preferences table definition.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create email preference record on first order</name>
  <files>
    src/app/api/webhook/route.ts
  </files>
  <action>
    In the webhook's checkout.session.completed handler, AFTER the order is successfully created (after the `const { data: order, error: orderError }` block) and BEFORE the order type branching logic:

    1. Add an upsert to email_preferences that creates a record for the user if one doesn't already exist:
       - Use supabase.from('email_preferences').upsert() with onConflict: 'user_id'
       - Fields: user_id (from userId), unsubscribe_token (generated via crypto.randomUUID()), global_unsubscribe: false, occasion_unsubscribes: []
       - The upsert ensures idempotency: first order creates the record, subsequent orders are no-ops
       - Import crypto from 'crypto' at the top of the file (Node built-in, no install needed)
       - Log on creation: console.log('Email preferences created for user:', userId)
       - Do NOT throw/break on failure -- email preferences are non-blocking for order processing. Just log the error.

    2. Keep all existing webhook logic completely intact. The email_preferences upsert is additive only.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - webhook/route.ts contains email_preferences upsert logic
    - webhook/route.ts still contains all original order processing logic
    - crypto import is present at top of file
  </verify>
  <done>
    Webhook creates email_preferences record with unique unsubscribe_token on first order. Subsequent orders for same user are no-ops due to upsert. Failure is non-blocking (logged but does not break order flow).
  </done>
</task>

</tasks>

<verification>
- Migration SQL file exists at supabase/migrations/004_add_email_preferences.sql
- TypeScript types compile without errors
- Webhook route contains email_preferences upsert in checkout handler
- All existing webhook functionality unchanged (order creation, bundle, upsell, generation triggers)
</verification>

<success_criteria>
- email_preferences table schema is defined with all required columns, indexes, and RLS policies
- TypeScript types for EmailPreferences and OccasionReminder are available for import
- Database interface in database.ts includes email_preferences
- Webhook automatically creates email preference record on first order
- Migration file ready for manual execution in Supabase SQL Editor
</success_criteria>

<output>
After completion, create `.planning/phases/09-retention-marketing/09-01-SUMMARY.md`
</output>
