---
phase: 02-base-payment-and-pricing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/stripe.ts
  - src/actions/checkout.ts
  - src/app/api/webhook/route.ts
  - supabase/migrations/002_add_order_type.sql
  - src/types/database.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Stripe Checkout Session is created with correct success_url containing {CHECKOUT_SESSION_ID} placeholder"
    - "Checkout metadata includes orderType field (base/upsell/bundle) for purchase categorization"
    - "Server Action creates authenticated checkout session and returns Stripe URL"
    - "Webhook handler stores order_type from session metadata when creating order record"
    - "Orders table has order_type column to distinguish base, upsell, and bundle purchases"
  artifacts:
    - path: "src/lib/stripe.ts"
      provides: "Updated createCheckoutSession with correct success_url and orderType metadata"
      contains: "CHECKOUT_SESSION_ID"
    - path: "src/actions/checkout.ts"
      provides: "Server Action for checkout session creation with auth check"
      exports: ["createCheckout"]
    - path: "src/app/api/webhook/route.ts"
      provides: "Webhook handler storing order_type from metadata"
      contains: "order_type"
    - path: "supabase/migrations/002_add_order_type.sql"
      provides: "SQL migration adding order_type column with default 'base'"
      contains: "order_type"
    - path: "src/types/database.ts"
      provides: "Updated TypeScript types with order_type field on orders"
      contains: "order_type"
  key_links:
    - from: "src/actions/checkout.ts"
      to: "src/lib/stripe.ts"
      via: "import createCheckoutSession"
      pattern: "createCheckoutSession"
    - from: "src/app/api/webhook/route.ts"
      to: "orders table"
      via: "insert with order_type from session.metadata.orderType"
      pattern: "order_type.*metadata"
---

<objective>
Update the Stripe integration backend to support proper checkout flow with session-based success URL, order type tracking, and a type-safe Server Action for checkout initiation.

Purpose: The existing stripe.ts has an incorrect success_url pattern (uses {ORDER_ID} which doesn't exist at checkout time). The webhook handler doesn't track order types. Without these fixes, the checkout flow can't properly redirect users after payment or categorize purchases for Phase 6 upsells.

Output: Updated stripe helper, new Server Action, updated webhook, database migration for order_type column, and updated TypeScript types.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-base-payment-and-pricing/02-RESEARCH.md

# Phase 1 built the webhook + Inngest integration
@.planning/phases/01-foundation-infrastructure/01-02-SUMMARY.md

# Existing files to modify
@src/lib/stripe.ts
@src/app/api/webhook/route.ts
@src/types/database.ts
@src/lib/supabase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Stripe helper and add checkout Server Action</name>
  <files>
    src/lib/stripe.ts
    src/actions/checkout.ts
  </files>
  <action>
**src/lib/stripe.ts** -- Update the existing `createCheckoutSession` function:

1. Change `product_data.name` from "Personalized Song" to "Personalized Song Package"
2. Change `product_data.description` to "Get 3 AI-generated song variants and pick your favorite"
3. Change `success_url` default from `/order/{ORDER_ID}?success=true` to `/checkout/success?session_id={CHECKOUT_SESSION_ID}` (CRITICAL: use literal `{CHECKOUT_SESSION_ID}` string -- Stripe replaces this automatically)
4. Change `cancel_url` default from `/customize?canceled=true` to `/pricing?canceled=true`
5. Add `orderType` parameter to the function signature with default `'base'`, type `'base' | 'upsell' | 'bundle'`
6. Add `orderType` to both `metadata` and `payment_intent_data.metadata` objects
7. Keep the existing `amount = 799` default, all other params unchanged

**src/actions/checkout.ts** -- Create new Server Action file:

1. Add `'use server'` directive at top
2. Import `createCheckoutSession` from `@/lib/stripe`
3. Import `createServerSupabaseClient` from `@/lib/supabase`
4. Export async function `createCheckout(customizationId: string)` that:
   - Creates server Supabase client
   - Gets authenticated user via `supabase.auth.getUser()` -- throw Error('Authentication required') if no user
   - Queries `customizations` table for the given ID where `user_id = user.id` to verify ownership
   - Throws Error('Customization not found') if not found
   - Calls `createCheckoutSession` with `customizationId`, `userId: user.id`, `email: user.email!`, `orderType: 'base'`
   - Returns `{ url: session.url }`

Follow existing conventions: single quotes, 2-space indent, console.error for errors, named exports, @/ path aliases.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | head -30` to check TypeScript compilation. Verify `src/actions/checkout.ts` exists and exports `createCheckout`. Verify `src/lib/stripe.ts` contains `CHECKOUT_SESSION_ID` in success_url and `orderType` in metadata.
  </verify>
  <done>
createCheckoutSession accepts orderType parameter and includes it in metadata. Success URL uses {CHECKOUT_SESSION_ID} placeholder. Server Action createCheckout authenticates user, verifies customization ownership, and returns Stripe checkout URL.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add order_type column and update webhook + types</name>
  <files>
    supabase/migrations/002_add_order_type.sql
    src/app/api/webhook/route.ts
    src/types/database.ts
  </files>
  <action>
**supabase/migrations/002_add_order_type.sql** -- Create SQL migration:

```sql
-- Add order_type column to orders table for purchase categorization (PAY-07)
-- Supports: base (default), upsell (+1 variant), bundle (multi-gen pack)
ALTER TABLE orders
ADD COLUMN order_type TEXT NOT NULL DEFAULT 'base'
CHECK (order_type IN ('base', 'upsell', 'bundle'));

-- Add index for filtering orders by type (dashboard, reporting)
CREATE INDEX idx_orders_order_type ON orders(order_type);
```

Note: This migration must be run manually in Supabase SQL Editor (same as Phase 1 migrations). Create the `supabase/migrations/` directory if it doesn't exist.

**src/app/api/webhook/route.ts** -- Update the `checkout.session.completed` handler:

1. After extracting `customizationId` and `userId` from metadata, also extract: `const orderType = session.metadata?.orderType || 'base'`
2. In the `.insert()` call that creates the order, add `order_type: orderType` to the insert object (alongside existing user_id, customization_id, stripe_session_id, status, amount)
3. Keep all existing logic unchanged (idempotency check, Inngest event trigger, error handling)

**src/types/database.ts** -- Update the orders type:

1. Add `OrderType` type alias: `export type OrderType = 'base' | 'upsell' | 'bundle'`
2. Add `order_type: OrderType` to orders Row interface (after `amount`)
3. Add `order_type?: OrderType` to orders Insert interface (optional with default from DB)
4. Add `order_type?: OrderType` to orders Update interface
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | head -30` for TypeScript check. Verify `supabase/migrations/002_add_order_type.sql` exists and contains ALTER TABLE. Verify webhook route.ts contains `order_type` in the insert call. Verify database.ts exports `OrderType`.
  </verify>
  <done>
orders table migration adds order_type column with CHECK constraint and index. Webhook handler extracts orderType from Stripe metadata and stores it. TypeScript types updated with OrderType union and order_type field on all order interfaces.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors related to new/modified files: `npx tsc --noEmit`
2. `src/actions/checkout.ts` exists with 'use server' directive and exports createCheckout
3. `src/lib/stripe.ts` success_url contains `{CHECKOUT_SESSION_ID}` (not `{ORDER_ID}`)
4. `src/lib/stripe.ts` metadata includes `orderType`
5. `src/app/api/webhook/route.ts` inserts `order_type` from session metadata
6. `supabase/migrations/002_add_order_type.sql` exists with ALTER TABLE and CHECK constraint
7. `src/types/database.ts` exports OrderType and includes order_type on orders interfaces
</verification>

<success_criteria>
- Stripe checkout session creation uses correct {CHECKOUT_SESSION_ID} success URL
- Server Action provides type-safe, authenticated checkout initiation
- Webhook stores order_type from Stripe metadata on every order
- Database migration ready for manual execution in Supabase SQL Editor
- TypeScript types are in sync with new database schema
</success_criteria>

<output>
After completion, create `.planning/phases/02-base-payment-and-pricing/02-01-SUMMARY.md`
</output>
