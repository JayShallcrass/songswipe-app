---
phase: 04-audio-generation-preview
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - src/components/generation/GenerationProgress.tsx
  - src/components/generation/VariantCard.tsx
  - src/components/generation/VariantSwiper.tsx
  - src/app/generate/[orderId]/page.tsx
  - src/app/checkout/success/page.tsx
autonomous: true

must_haves:
  truths:
    - "User sees per-variant progress indicators (pending/generating/complete/failed) during generation"
    - "User can swipe between completed variants to listen to protected preview audio"
    - "User can select their favorite variant via swipe or button"
    - "Checkout success page redirects user to the generation page where they wait and swipe"
    - "Partial success: user sees completed variants even if some failed"
  artifacts:
    - path: "src/components/generation/GenerationProgress.tsx"
      provides: "Progress UI with overall bar and per-variant status icons"
      contains: "GenerationProgress"
    - path: "src/components/generation/VariantCard.tsx"
      provides: "Audio preview card component for swipe"
      contains: "VariantCard"
    - path: "src/components/generation/VariantSwiper.tsx"
      provides: "Swipe container for variant selection with audio playback"
      contains: "VariantSwiper"
    - path: "src/app/generate/[orderId]/page.tsx"
      provides: "Generation page orchestrating progress and variant selection"
      contains: "GenerationPage"
    - path: "src/app/checkout/success/page.tsx"
      provides: "Updated success page that redirects to generation page"
      contains: "CheckoutSuccessPage"
  key_links:
    - from: "src/app/generate/[orderId]/page.tsx"
      to: "src/lib/hooks/useGenerationStatus.ts"
      via: "hook consumption"
      pattern: "useGenerationStatus.*orderId"
    - from: "src/components/generation/VariantSwiper.tsx"
      to: "src/lib/hooks/useAudioPreview.ts"
      via: "hook consumption in child cards"
      pattern: "useAudioPreview"
    - from: "src/components/generation/VariantSwiper.tsx"
      to: "/api/orders/[id]/variants/[variantId]/select"
      via: "fetch POST on variant selection"
      pattern: "fetch.*select.*POST"
    - from: "src/app/checkout/success/page.tsx"
      to: "src/app/generate/[orderId]/page.tsx"
      via: "redirect or link"
      pattern: "generate.*orderId"
---

<objective>
Build the generation page UI that shows real-time progress during song generation and enables swipe-based variant selection with protected audio playback. Update the checkout success page to direct users to the generation experience.

Purpose: This is the culmination of Phase 4 -- the user-facing experience where they watch their songs being created and then swipe to pick their favorite. This ties together the status polling API, audio preview API, and variant selection API from Plan 01 with the hooks from Plan 02 into a cohesive, interactive page.

Output: GenerationProgress component, VariantCard with audio player, VariantSwiper with Framer Motion gestures, /generate/[orderId] page, and updated checkout success page.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-audio-generation-preview/04-01-PLAN.md
@.planning/phases/04-audio-generation-preview/04-02-PLAN.md
@.planning/phases/04-audio-generation-preview/04-RESEARCH.md
@src/components/swipe/SwipeCard.tsx
@src/app/checkout/success/page.tsx
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GenerationProgress and VariantCard components</name>
  <files>
    src/components/generation/GenerationProgress.tsx
    src/components/generation/VariantCard.tsx
  </files>
  <action>
1. Create `src/components/generation/GenerationProgress.tsx`:
- `'use client'`
- Import `useGenerationStatus` from `@/lib/hooks/useGenerationStatus`
- Accept props: `{ orderId: string, onAllComplete?: () => void }`
- Call `useGenerationStatus(orderId)` to get status data
- Show loading skeleton while `isLoading`
- Show error state if `error`

UI structure (matching existing purple/gradient theme from checkout success page):
- Heading: "Creating your songs..." (during generation) or "Your songs are ready!" (when complete)
- Subtext: "X/3 variants complete" counter
- Overall progress bar: width percentage = (completedCount / 3) * 100, use purple gradient (`bg-gradient-to-r from-purple-500 to-pink-500`), animated transition with `transition-all duration-500`
- Per-variant status list (3 rows):
  - 'pending': gray circle outline + "Variant N: Waiting..."
  - 'generating': animated spinner (border-2 border-purple-500 border-t-transparent rounded-full animate-spin) + "Variant N: Generating..."
  - 'complete': green checkmark SVG + "Variant N: Ready"
  - 'failed': red X SVG + "Variant N: Failed"
- If any variant failed but others succeeded, show info banner: "Some variants could not be generated. You can still listen to the successful ones."
- Call `onAllComplete?.()` when `isComplete` becomes true (use useEffect to detect transition)

Style: Use Tailwind consistent with existing app (rounded-2xl, shadow-xl, gradient backgrounds). Match the purple-to-pink gradient theme used across the app.

2. Create `src/components/generation/VariantCard.tsx`:
- `'use client'`
- Import `useAudioPreview` from `@/lib/hooks/useAudioPreview`
- Accept props: `{ orderId: string, variantId: string, variantNumber: number, isActive: boolean }`
- Call `useAudioPreview(orderId, isActive ? variantId : null)` -- only load audio when card is active (prevents loading all 3 simultaneously)
- Show loading state while audio is loading
- Show error state if audio fetch fails

Audio player:
- HTML5 `<audio>` element with `controls`, `controlsList="nodownload noplaybackrate"`, `onContextMenu={(e) => e.preventDefault()}`
- Set `src={audioUrl}` from the hook (blob URL)
- Ref from hook for potential programmatic control
- Style: `w-full` width, custom wrapper with rounded corners

Card content:
- Large variant number label: "Variant {variantNumber}" in bold
- "Swipe to compare, or tap Select" subtitle
- Audio player in center
- Select button at bottom: purple gradient, "Select This One" text
- Card background: white with subtle gradient border or shadow, rounded-2xl

Do NOT duplicate the full SwipeCard drag logic here -- that goes in VariantSwiper. VariantCard is a pure presentation component for the card content.
  </action>
  <verify>
`ls src/components/generation/GenerationProgress.tsx src/components/generation/VariantCard.tsx` confirms both exist.
TypeScript compilation passes for new components.
  </verify>
  <done>
GenerationProgress shows live per-variant progress with animated bar and status icons. VariantCard displays audio player with anti-download controls and loads audio lazily only when active. Both use the app's purple gradient theme.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create VariantSwiper, generation page, and update checkout success</name>
  <files>
    src/components/generation/VariantSwiper.tsx
    src/app/generate/[orderId]/page.tsx
    src/app/checkout/success/page.tsx
  </files>
  <action>
1. Create `src/components/generation/VariantSwiper.tsx`:
- `'use client'`
- Import `motion, AnimatePresence` from `framer-motion`
- Import `VariantCard` from `@/components/generation/VariantCard`
- Accept props: `{ orderId: string, variants: Array<{ id: string, variant_number: number }>, onSelect: (variantId: string) => void }`
- State: `currentIndex` (useState, default 0)
- Display current variant using VariantCard (pass isActive=true for current, false for others)
- Navigation: Left/right arrow buttons to move between variants (not full swipe like Phase 3, since user needs to interact with audio controls -- swiping would conflict with audio scrubbing)
- Actually, use a SIMPLIFIED swipe: swiping the card area (above the audio controls) navigates between variants. But since audio controls need touch interaction, implement navigation via:
  - Left/Right arrow buttons flanking the card
  - Dot indicators below showing current position (like Phase 3 SwipeProgress dots)
  - Keyboard: ArrowLeft/ArrowRight to navigate between variants
  - Swipe gesture on card header area only (optional, can be added later)

- When user taps "Select This One" on VariantCard:
  - Call `onSelect(currentVariant.id)`
  - Show confirmation state: "Selected!" with checkmark animation

- AnimatePresence for card transitions: slide in from right when navigating forward, from left when navigating backward. Use x offset animation similar to Phase 3 exit animations.

Variant count indicator:
- "Variant X of Y" text above the card
- Dot indicators below: purple filled for current, gray for others (match SwipeProgress dots style)

2. Create `src/app/generate/[orderId]/page.tsx`:
- `'use client'`
- Import `useGenerationStatus` from `@/lib/hooks/useGenerationStatus`
- Import `GenerationProgress` from `@/components/generation/GenerationProgress`
- Import `VariantSwiper` from `@/components/generation/VariantSwiper`
- Get `orderId` from `params` (Next.js dynamic route)
- State: `showSwiper` (boolean, default false) -- transitions from progress to swiper
- State: `selectedVariantId` (string | null)

Page flow:
- Phase A (generating): Show `GenerationProgress` with `onAllComplete={() => setShowSwiper(true)}`
- But also: if ANY variant is complete (partial success), show a "Preview ready variants" button that also sets showSwiper=true
- Phase B (swiper): Show `VariantSwiper` with completed variants, allow selection
- Phase C (selected): Show confirmation with "Your song has been selected!" message and link to dashboard

onSelect handler:
- POST to `/api/orders/${orderId}/variants/${selectedVariantId}/select`
- Set selectedVariantId on success
- Show error toast if fails (use window.alert as fallback since no toast library installed)

Page styling: Same gradient background as checkout success (from-green-50 via-white to-purple-50 during generation, shift to celebratory after selection). Centered max-w-2xl container.

Handle edge cases:
- No orderId: show error
- Order not found (API 404): show "Order not found" with link to dashboard
- All variants failed: show "Generation failed" with support contact info

3. Update `src/app/checkout/success/page.tsx`:
- The success page currently shows a static "Your song is being generated" message with "Go to Dashboard" CTA
- Need to retrieve the order ID from the Stripe session to redirect to the generation page
- Problem: The success page only has session_id, not order_id. The order is created by the webhook which fires asynchronously.
- Solution: Add a lookup mechanism. After payment, the success page should:
  1. Show the existing success message immediately (good UX, instant feedback)
  2. Add a prominent CTA: "Watch Your Song Being Created" linking to the generation page
  3. To get the order ID from session_id: fetch `/api/orders?session_id=${sessionId}` and use the returned order ID
  4. BUT the order might not exist yet (webhook hasn't fired). Handle this gracefully.

Simplest approach: Update the existing success page to:
- Keep existing design
- Replace "Go to Dashboard" primary CTA with "Watch Your Song Being Created" that links to `/generate/${orderId}`
- Add a useEffect that polls for the order by session_id: fetch `/api/orders?session_id=${sessionId}` every 2 seconds until found, then set orderId state
- While waiting for order to appear: show the existing "being generated" text and a small spinner
- Once order found: show the "Watch Your Song" button with the order ID link
- Fallback after 30 seconds: show "Go to Dashboard" (something went wrong with webhook)

For the order lookup, update the existing `/api/orders` route to accept a `session_id` query param and return the matching order. Read the existing `src/app/api/orders/route.ts` first to understand its current implementation and add the session_id filter.
  </action>
  <verify>
`ls src/components/generation/VariantSwiper.tsx src/app/generate/\[orderId\]/page.tsx` confirms files exist.
Verify checkout success page updated: grep for "generate" in src/app/checkout/success/page.tsx.
TypeScript compilation passes for all new/modified files.
  </verify>
  <done>
VariantSwiper enables navigation between completed variants with arrow buttons, dot indicators, and audio playback. Generation page orchestrates the full flow: progress watching, variant swiping, and selection confirmation. Checkout success page redirects users to the generation page by looking up their order via session_id. User can watch generation progress in real-time and pick their favorite variant.
  </done>
</task>

</tasks>

<verification>
1. Generation page at /generate/[orderId] shows progress during generation
2. GenerationProgress shows per-variant status with animated progress bar
3. VariantSwiper allows navigating between completed variants with audio playback
4. Audio plays via HTML5 audio element with download prevention (controlsList="nodownload")
5. User can select a variant which POSTs to the select endpoint
6. Checkout success page links to the generation page with the order ID
7. Partial success: completed variants are available for preview even if others are still generating/failed
8. All new files pass TypeScript compilation
</verification>

<success_criteria>
Complete generation-to-selection flow works: user arrives at /generate/[orderId] after checkout, sees real-time progress as 3 variants generate, navigates between completed variants with protected audio playback, selects their favorite, and sees confirmation. Checkout success page directs users to this experience.
</success_criteria>

<output>
After completion, create `.planning/phases/04-audio-generation-preview/04-03-SUMMARY.md`
</output>
