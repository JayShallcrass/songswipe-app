---
phase: 03-swipe-builder
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/swipe/SwipeStack.tsx
  - src/components/swipe/SwipeProgress.tsx
  - src/components/swipe/SwipeHints.tsx
  - src/lib/swipe-keyboard.ts
autonomous: true

must_haves:
  truths:
    - "User sees a stack of cards for the current swipe stage and can drag the top card left or right"
    - "After swiping right, user advances to the next stage (occasion -> mood -> genre -> voice)"
    - "Progress bar updates to show which stage the user is on out of 4 stages"
    - "First-time users see animated visual hints showing how to swipe (dismissed after first swipe or tap)"
    - "Arrow keys and Enter/Escape provide full keyboard control matching touch gestures"
    - "Undo button is visible when canUndo is true and reverts the last swipe action"
  artifacts:
    - path: "src/components/swipe/SwipeStack.tsx"
      provides: "Card stack orchestrator rendering current stage cards with swipe handling and undo button"
      exports: ["SwipeStack"]
    - path: "src/components/swipe/SwipeProgress.tsx"
      provides: "Visual progress bar showing current stage out of 4"
      exports: ["SwipeProgress"]
    - path: "src/components/swipe/SwipeHints.tsx"
      provides: "Animated tutorial overlay for first-time users with localStorage dismissal"
      exports: ["SwipeHints"]
    - path: "src/lib/swipe-keyboard.ts"
      provides: "useSwipeKeyboard hook for arrow key, Enter, and Escape keyboard control"
      exports: ["useSwipeKeyboard"]
  key_links:
    - from: "src/components/swipe/SwipeStack.tsx"
      to: "src/components/swipe/SwipeCard.tsx"
      via: "renders SwipeCard components for current stage cards"
      pattern: "SwipeCard"
    - from: "src/components/swipe/SwipeStack.tsx"
      to: "src/lib/swipe-state.ts"
      via: "receives swipe state and handlers as props from parent"
      pattern: "handleSwipe|canUndo|undo"
    - from: "src/components/swipe/SwipeStack.tsx"
      to: "src/components/swipe/SwipeHints.tsx"
      via: "renders SwipeHints overlay on the card stack"
      pattern: "SwipeHints"
    - from: "src/lib/swipe-keyboard.ts"
      to: "window keydown event"
      via: "useEffect event listener for ArrowLeft, ArrowRight, Enter, Escape"
      pattern: "ArrowLeft|ArrowRight"
---

<objective>
Build the swipe flow UI components: the card stack orchestrator that manages which cards to show for each stage, progress indicator, first-time user tutorial hints, and keyboard navigation support.

Purpose: These components compose the foundation pieces from Plan 03-01 into an interactive multi-stage swipe experience. The SwipeStack is the main visual element users interact with, while SwipeProgress, SwipeHints, and keyboard controls ensure the experience is accessible and intuitive.

Output: SwipeStack component, SwipeProgress bar, SwipeHints overlay, and useSwipeKeyboard hook.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-swipe-builder/03-RESEARCH.md

# Plan 03-01 creates these dependencies
@.planning/phases/03-swipe-builder/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build SwipeStack orchestrator and SwipeProgress components</name>
  <files>
    src/components/swipe/SwipeStack.tsx
    src/components/swipe/SwipeProgress.tsx
  </files>
  <action>
**src/components/swipe/SwipeStack.tsx** -- Card stack orchestrator:

1. Add `'use client'` directive
2. Import `SwipeCard` from `@/components/swipe/SwipeCard`
3. Import `SwipeHints` from `@/components/swipe/SwipeHints`
4. Import `SwipeCardData`, `SwipeStage` from `@/types/swipe`
5. Import `AnimatePresence`, `motion` from 'framer-motion'

6. Define `SwipeStackProps` interface:
   - `cards: SwipeCardData[]` (cards for current stage)
   - `currentCardIndex: number` (which card is on top)
   - `stage: SwipeStage` (current stage identifier)
   - `stageTitle: string` (heading text, e.g., "What's the occasion?")
   - `stageSubtitle: string` (helper text)
   - `onSwipe: (cardId: string, direction: 'left' | 'right') => void`
   - `onUndo: () => void`
   - `canUndo: boolean`
   - `showHints: boolean` (whether to show first-time hints)
   - `onHintsDismiss: () => void`

7. Component logic:
   - Calculate visible cards: show the current card on top, plus up to 2 cards behind it (stacked offset). Cards are `cards.slice(currentCardIndex, currentCardIndex + 3)`.
   - If `currentCardIndex >= cards.length`, show a "No more options" message with prompt to undo or go back.
   - When SwipeCard calls `onSwipe`, pass through with the current card's `id`: `onSwipe(cards[currentCardIndex].id, direction)`

8. Render layout:
   - Stage title and subtitle at the top (text-2xl font-bold, text-gray-600 subtitle)
   - Card stack container: relative, `w-full max-w-sm aspect-[3/4] mx-auto` (matches existing SwipeInterface sizing)
   - Render cards in reverse order (back to front) with slight scale and translateY offset for depth:
     - Card at index 0 (top): scale(1), translateY(0) -- isTop=true
     - Card at index 1: scale(0.95), translateY(8px) -- isTop=false
     - Card at index 2: scale(0.90), translateY(16px) -- isTop=false
   - Use `AnimatePresence` with `mode="popLayout"` to animate card exits when swiped
   - Exit animation: `{ x: direction === 'right' ? 300 : -300, opacity: 0, rotate: direction === 'right' ? 15 : -15 }` with 0.3s transition
   - Undo button below card stack: only visible when `canUndo` is true
     - Style: text button with undo arrow icon (unicode â†©), text-gray-500, hover:text-gray-700
     - Text: "Undo"
     - onClick: calls `onUndo`
   - Render `SwipeHints` overlay when `showHints` is true
   - Desktop fallback buttons below the card stack (visible alongside undo):
     - "Skip" button (left swipe equivalent): outline style, text-gray-600
     - "Select" button (right swipe equivalent): gradient purple-to-pink, white text
     - These provide mouse-click alternatives to dragging

**src/components/swipe/SwipeProgress.tsx** -- Stage progress indicator:

1. Add `'use client'` directive
2. Import `SwipeStage` from `@/types/swipe`
3. Import `STAGE_ORDER` from `@/lib/swipe-data`

4. Define `SwipeProgressProps`:
   - `currentStage: SwipeStage`
   - `selections: Partial<Record<SwipeStage, string>>`

5. Component renders:
   - A horizontal row of 4 stage indicators (dots/circles with labels)
   - Each stage shows: small circle (completed = filled purple, current = outlined purple with pulse, upcoming = gray)
   - Stage labels below each dot: "Occasion", "Mood", "Genre", "Voice"
   - Connecting lines between dots (purple if completed, gray if not)
   - Overall progress bar below: thin gradient bar showing percentage (0%, 25%, 50%, 75%, 100%)
   - Use Tailwind transitions for smooth visual updates

Follow existing conventions: single quotes, 2-space indent, 'use client', PascalCase components, gradient purple-to-pink matching existing theme.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | head -30` for TypeScript check. Verify `src/components/swipe/SwipeStack.tsx` exports SwipeStack and imports SwipeCard. Verify `src/components/swipe/SwipeProgress.tsx` exports SwipeProgress and references STAGE_ORDER.
  </verify>
  <done>
SwipeStack renders current stage cards with proper stacking, handles swipe callbacks, shows undo button when available, provides desktop click fallback buttons, and animates card exits. SwipeProgress shows visual stage-by-stage progress with dots, labels, and connecting lines.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build SwipeHints overlay and useSwipeKeyboard hook</name>
  <files>
    src/components/swipe/SwipeHints.tsx
    src/lib/swipe-keyboard.ts
  </files>
  <action>
**src/components/swipe/SwipeHints.tsx** -- First-time user tutorial overlay:

1. Add `'use client'` directive
2. Import `motion` from 'framer-motion'
3. Import `useState` from 'react'

4. Define `SwipeHintsProps`:
   - `onDismiss: () => void`

5. Component logic:
   - Check `localStorage.getItem('songswipe_hints_seen')` on mount. If already seen, call `onDismiss()` immediately and return null.
   - When dismissed (via button click or onDismiss callback): set `localStorage.setItem('songswipe_hints_seen', 'true')`, call `onDismiss()`

6. Render: Semi-transparent overlay positioned over the card stack (absolute positioning, pointer-events managed so user can still interact):
   - Left side hint: animated arrow pointing left with text "Swipe left to skip"
     - Arrow animates: `x: [-20, 0, -20]` repeating, duration 1.5s
   - Right side hint: animated arrow pointing right with text "Swipe right to select"
     - Arrow animates: `x: [20, 0, 20]` repeating, duration 1.5s
   - Bottom center: "Tap anywhere to dismiss" text
   - Optional "Got it!" button at bottom for explicit dismissal (pointer-events-auto)
   - Semi-transparent dark backdrop (bg-black/20) for contrast
   - Text in white with subtle shadow for readability against colored cards
   - Use `motion.div` for entrance animation: `initial={{ opacity: 0 }}, animate={{ opacity: 1 }}`

**src/lib/swipe-keyboard.ts** -- Keyboard navigation hook:

1. Add `'use client'` directive
2. Import `useEffect`, `useCallback` from 'react'

3. Define `UseSwipeKeyboardProps` interface:
   - `onSwipeLeft: () => void`
   - `onSwipeRight: () => void`
   - `onUndo: () => void`
   - `canUndo: boolean`
   - `disabled?: boolean` (disable keyboard when on personalization form to avoid conflicts with text input)

4. Export `useSwipeKeyboard` hook:
   - Create memoized `handleKeyDown` callback:
     - If `disabled`, return early
     - Check if active element is an input, textarea, or select -- if so, return early (don't hijack form input)
     - `ArrowLeft` -> call `onSwipeLeft()`, `e.preventDefault()`
     - `ArrowRight` -> call `onSwipeRight()`, `e.preventDefault()`
     - `Enter` -> call `onSwipeRight()`, `e.preventDefault()` (Enter = select = right swipe)
     - `Escape` -> if `canUndo`, call `onUndo()`, `e.preventDefault()`
   - Add/remove `keydown` event listener via `useEffect`
   - Dependencies: all callbacks, canUndo, disabled

Follow existing conventions: single quotes, 2-space indent, named exports, @/ path aliases. Keyboard hook must check for active form elements to avoid interfering with the personalization form text inputs (SWIPE-06 requirement).
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | head -30` for TypeScript check. Verify `src/components/swipe/SwipeHints.tsx` exports SwipeHints and contains localStorage check for 'songswipe_hints_seen'. Verify `src/lib/swipe-keyboard.ts` exports useSwipeKeyboard and contains 'ArrowLeft', 'ArrowRight', 'Enter', 'Escape' key handling with form element check.
  </verify>
  <done>
SwipeHints shows animated tutorial overlay for first-time users, persists dismissal in localStorage, and auto-dismisses if already seen. useSwipeKeyboard provides full keyboard navigation (arrows, Enter, Escape) with proper form input detection to avoid conflicts.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles without errors
2. `src/components/swipe/SwipeStack.tsx` renders SwipeCard components, handles onSwipe, shows undo button, has AnimatePresence for exit animations
3. `src/components/swipe/SwipeProgress.tsx` shows 4-stage progress with dots, labels, and connecting lines
4. `src/components/swipe/SwipeHints.tsx` shows animated hints on first visit, persists dismissal in localStorage
5. `src/lib/swipe-keyboard.ts` handles ArrowLeft, ArrowRight, Enter, Escape with form element check
6. All components follow existing codebase conventions (single quotes, 2-space indent, 'use client', gradient theme)
</verification>

<success_criteria>
- SwipeStack manages card display, stacking depth, exit animations, undo button, and desktop click fallbacks
- SwipeProgress visually communicates stage progression through 4 stages
- SwipeHints guides first-time users with animated visual cues and remembers dismissal
- Keyboard hook provides full ArrowLeft/ArrowRight/Enter/Escape control without interfering with text inputs
- All components pass TypeScript compilation
</success_criteria>

<output>
After completion, create `.planning/phases/03-swipe-builder/03-02-SUMMARY.md`
</output>
