---
phase: 03-swipe-builder
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/types/swipe.ts
  - src/lib/swipe-data.ts
  - src/lib/swipe-state.ts
  - src/components/swipe/SwipeCard.tsx
autonomous: true

must_haves:
  truths:
    - "SwipeCard renders card content with title, icon, and description and can be dragged horizontally"
    - "Dragging a card less than 40% of card width snaps it back to center (no selection registered)"
    - "Dragging a card beyond 40% threshold or with high velocity triggers onSwipe callback with direction"
    - "Swipe state persists in sessionStorage and survives page refresh"
    - "Undo removes the last selection and moves back to the previous stage"
    - "Card data arrays exist for occasion, mood, genre, and voice style categories"
  artifacts:
    - path: "src/types/swipe.ts"
      provides: "TypeScript interfaces for swipe flow state, card data, and stage types"
      exports: ["SwipeStage", "SwipeCardData", "SwipeFlowState", "SwipeSelection"]
    - path: "src/lib/swipe-data.ts"
      provides: "Card content arrays for all four swipe stages plus voice styles"
      exports: ["occasionCards", "moodCards", "genreCards", "voiceCards", "STAGE_ORDER", "STAGE_CONFIG"]
    - path: "src/lib/swipe-state.ts"
      provides: "useSwipeState hook with sessionStorage persistence, undo, and reset"
      exports: ["useSwipeState"]
    - path: "src/components/swipe/SwipeCard.tsx"
      provides: "Draggable card component using Framer Motion with 40% threshold and visual feedback"
      exports: ["SwipeCard"]
  key_links:
    - from: "src/components/swipe/SwipeCard.tsx"
      to: "src/types/swipe.ts"
      via: "import SwipeCardData type"
      pattern: "SwipeCardData"
    - from: "src/lib/swipe-state.ts"
      to: "src/types/swipe.ts"
      via: "import SwipeFlowState type"
      pattern: "SwipeFlowState"
    - from: "src/lib/swipe-data.ts"
      to: "src/types/swipe.ts"
      via: "import SwipeCardData and SwipeStage types"
      pattern: "SwipeCardData"
---

<objective>
Build the swipe engine foundation: TypeScript types, card content data, state management hook with sessionStorage persistence and undo, and the core draggable SwipeCard component using Framer Motion.

Purpose: This plan creates the reusable building blocks that Plan 03-02 (swipe flow UI) and Plan 03-03 (page integration) depend on. The SwipeCard with proper 40% threshold and the useSwipeState hook with undo are the atomic units of the entire swipe experience.

Output: Installable framer-motion dependency, type definitions, card data arrays, state hook, and SwipeCard component.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-swipe-builder/03-RESEARCH.md

# Existing schema and types for reference
@src/lib/elevenlabs.ts
@src/types/database.ts

# Existing customize page has occasion/mood/genre arrays to align with
@src/app/customize/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Framer Motion and create swipe types and card data</name>
  <files>
    package.json
    src/types/swipe.ts
    src/lib/swipe-data.ts
  </files>
  <action>
**Install framer-motion:**

Run `npm install framer-motion@^11` to add the gesture/animation library.

**src/types/swipe.ts** -- Create TypeScript interfaces:

1. `SwipeStage` type: `'occasion' | 'mood' | 'genre' | 'voice'` (4 swipe stages, personalization is a form not swipe)
2. `SwipeCardData` interface:
   - `id: string` (unique identifier, e.g., 'valentines', 'pop')
   - `title: string` (display name, e.g., "Valentine's Day")
   - `icon: string` (emoji, e.g., 'üíï')
   - `description: string` (short description for the card body)
   - `gradient: string` (Tailwind gradient classes for card background, e.g., 'from-pink-500 to-rose-500')
3. `SwipeSelection` interface:
   - `stage: SwipeStage`
   - `cardId: string`
   - `direction: 'left' | 'right'`
4. `SwipeFlowState` interface:
   - `currentStage: SwipeStage`
   - `currentCardIndex: number` (which card within current stage)
   - `selections: Partial<Record<SwipeStage, string>>` (the right-swiped choice for each stage)
   - `history: SwipeSelection[]` (full history for undo)
5. `StageConfig` interface:
   - `stage: SwipeStage`
   - `title: string` (heading for the stage, e.g., "What's the occasion?")
   - `subtitle: string` (helper text, e.g., "Swipe right to select, left to skip")
   - `cards: SwipeCardData[]`
   - `selectionMode: 'single'` (all stages are single-select via swipe -- right swipe = select, moves to next stage)

Export all types as named exports.

**src/lib/swipe-data.ts** -- Create card content arrays:

Import `SwipeCardData`, `SwipeStage`, and `StageConfig` from `@/types/swipe`.

1. `occasionCards: SwipeCardData[]` -- 6 cards matching existing customize page values:
   - valentines: "Valentine's Day", 'üíï', "Express your love with a romantic melody", 'from-pink-500 to-rose-500'
   - birthday: "Birthday", 'üéÇ', "Celebrate their special day with a song", 'from-amber-500 to-orange-500'
   - anniversary: "Anniversary", 'üíç', "Mark your milestone with music", 'from-purple-500 to-violet-500'
   - wedding: "Wedding", 'üë∞', "The perfect musical wedding gift", 'from-emerald-500 to-teal-500'
   - graduation: "Graduation", 'üéì', "Celebrate their achievement in song", 'from-blue-500 to-indigo-500'
   - just-because: "Just Because", '‚ú®', "No occasion needed, just love", 'from-fuchsia-500 to-pink-500'

2. `moodCards: SwipeCardData[]` -- 5 cards matching existing mood values:
   - romantic: "Romantic", '‚ù§Ô∏è', "Tender and heartfelt", 'from-rose-500 to-pink-600'
   - happy: "Happy", 'üòä', "Upbeat and joyful", 'from-yellow-400 to-amber-500'
   - funny: "Funny", 'üòÑ', "Playful and lighthearted", 'from-lime-500 to-green-500'
   - nostalgic: "Nostalgic", 'üåÖ', "Warm and reflective", 'from-amber-600 to-orange-600'
   - epic: "Epic", 'üöÄ', "Grand and powerful", 'from-indigo-600 to-purple-700'

3. `genreCards: SwipeCardData[]` -- 5 cards matching existing genre values:
   - pop: "Pop", 'üéµ', "Modern and catchy", 'from-pink-500 to-purple-500'
   - acoustic: "Acoustic", 'üé∏', "Warm and organic", 'from-amber-500 to-yellow-600'
   - electronic: "Electronic", 'üéπ', "Synth-driven and dynamic", 'from-cyan-500 to-blue-600'
   - orchestral: "Orchestral", 'üéª', "Rich and cinematic", 'from-red-600 to-rose-700'
   - jazz: "Jazz", 'üé∑', "Smooth and sophisticated", 'from-indigo-500 to-blue-700'

4. `voiceCards: SwipeCardData[]` -- 5 voice style options (new data not in existing codebase):
   - warm-male: "Warm Male", 'üé§', "Rich baritone, smooth delivery", 'from-blue-600 to-indigo-600'
   - bright-female: "Bright Female", 'üé§', "Clear soprano, energetic feel", 'from-pink-500 to-rose-600'
   - soulful: "Soulful", 'üé§', "Deep, emotional R&B style", 'from-purple-600 to-violet-700'
   - energetic: "Energetic", 'üé§', "Powerful, upbeat vocal style", 'from-orange-500 to-red-500'
   - gentle: "Gentle", 'üé§', "Soft, intimate whisper-style", 'from-teal-500 to-emerald-600'

5. `STAGE_ORDER: SwipeStage[]` -- `['occasion', 'mood', 'genre', 'voice']`

6. `STAGE_CONFIG: StageConfig[]` -- Array of 4 stage configs referencing the card arrays:
   - occasion: "What's the occasion?", "Swipe right to select"
   - mood: "Set the mood", "What vibe should your song have?"
   - genre: "Pick a genre", "What style of music?"
   - voice: "Choose a voice", "Who should sing your song?"

Follow existing conventions: single quotes, 2-space indent, named exports, @/ path aliases.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | head -30` to check TypeScript compilation. Verify `src/types/swipe.ts` exists and exports SwipeStage, SwipeCardData, SwipeFlowState. Verify `src/lib/swipe-data.ts` exists and exports occasionCards with 6 items, moodCards with 5, genreCards with 5, voiceCards with 5, STAGE_ORDER with 4 items.
  </verify>
  <done>
Framer-motion installed. Type definitions cover all swipe flow state. Card data arrays for all 4 stages have content aligned with existing customize page values (occasion, mood, genre) plus new voice style data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useSwipeState hook and SwipeCard component</name>
  <files>
    src/lib/swipe-state.ts
    src/components/swipe/SwipeCard.tsx
  </files>
  <action>
**src/lib/swipe-state.ts** -- Create the swipe state management hook:

1. Add `'use client'` directive (uses useState, useEffect)
2. Import `useState`, `useEffect`, `useCallback` from 'react'
3. Import `SwipeFlowState`, `SwipeStage`, `SwipeSelection` from `@/types/swipe`
4. Import `STAGE_ORDER`, `STAGE_CONFIG` from `@/lib/swipe-data`

5. Define `STORAGE_KEY = 'songswipe_builder_state'`

6. Define `initialState: SwipeFlowState`:
   - `currentStage: 'occasion'`
   - `currentCardIndex: 0`
   - `selections: {}`
   - `history: []`

7. Export `useSwipeState()` hook that returns:
   - `state: SwipeFlowState` -- current state
   - `handleSwipe: (cardId: string, direction: 'left' | 'right') => void`:
     - If direction is 'right': store selection for current stage (`selections[currentStage] = cardId`), push to history, advance to next stage (reset currentCardIndex to 0), or mark as complete if last stage
     - If direction is 'left': push to history (with 'left' direction), increment currentCardIndex to show next card in same stage. If no more cards in current stage, stay on last card (user must swipe right on one to proceed)
   - `undo: () => void`:
     - Pop last entry from history
     - If last entry was a right swipe (selection): clear that stage's selection, go back to that stage, set currentCardIndex to find the card that was selected
     - If last entry was a left swipe (skip): go back to that stage at the previous card index
   - `reset: () => void`:
     - Clear sessionStorage
     - Reset to initialState
   - `canUndo: boolean` -- history.length > 0
   - `isSwipeComplete: boolean` -- all 4 stages have selections in state.selections
   - `progress: number` -- percentage (0-100) based on how many stages have selections
   - `currentStageConfig: StageConfig | undefined` -- the config object for the current stage from STAGE_CONFIG

8. Persist state to sessionStorage on every change via useEffect (JSON.stringify). Load from sessionStorage on mount (with try/catch for corrupted JSON -- fall back to initialState).

**src/components/swipe/SwipeCard.tsx** -- Create the draggable card:

1. Add `'use client'` directive
2. Import `motion`, `useMotionValue`, `useTransform` from 'framer-motion'
3. Import `SwipeCardData` from `@/types/swipe`

4. Define `SwipeCardProps` interface:
   - `card: SwipeCardData`
   - `onSwipe: (direction: 'left' | 'right') => void`
   - `isTop: boolean` (is this the front card in the stack)

5. Export `SwipeCard` component:
   - Use `useMotionValue(0)` for x position
   - Use `useTransform(x, [-200, 0, 200], [-15, 0, 15])` for rotation (subtle tilt while dragging)
   - Use `useTransform(x, [-200, -100, 0, 100, 200], [0.3, 0.8, 0, 0.8, 0.3])` for left/right indicator opacity
   - `onDragEnd` handler:
     - Get card width via `(event.currentTarget as HTMLElement).offsetWidth`
     - Calculate threshold as `cardWidth * 0.4` (40% requirement per SWIPE-09)
     - Check `Math.abs(info.offset.x) > threshold || Math.abs(info.velocity.x) > 500`
     - If threshold met: call `onSwipe(offset > 0 ? 'right' : 'left')`
     - If not met: card snaps back automatically (Framer Motion dragConstraints handles this)
   - Render: `motion.div` with:
     - `drag="x"` (horizontal drag only)
     - `dragConstraints={{ left: 0, right: 0 }}` (snap back when released)
     - `dragElastic={0.7}` (stretchy feel during drag)
     - `style={{ x, rotate, touchAction: 'none' }}` (prevent scroll conflicts per research)
     - `whileDrag={{ scale: 1.02, cursor: 'grabbing' }}`
     - `className`: absolute positioned, full width/height, cursor-grab (cursor-grabbing when dragging)
     - Only enable drag when `isTop` is true (back cards shouldn't be draggable)
   - Card visual content:
     - Gradient background using `card.gradient` classes on a rounded-2xl container
     - Icon display (large, centered, e.g., text-6xl)
     - Title (text-2xl font-bold, white text)
     - Description (text-white/80, smaller text)
     - Left/right indicator overlays that fade in during drag:
       - Left side: red-tinted "SKIP" label, opacity driven by leftward drag
       - Right side: green-tinted "SELECT" label, opacity driven by rightward drag

Follow existing conventions: single quotes, 2-space indent, 'use client' directive, PascalCase component files, camelCase functions.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | head -30` to verify no TypeScript errors. Verify `src/lib/swipe-state.ts` exports useSwipeState. Verify `src/components/swipe/SwipeCard.tsx` exports SwipeCard and contains `drag="x"`, `0.4` (threshold), and `touchAction: 'none'`.
  </verify>
  <done>
useSwipeState hook manages swipe flow with sessionStorage persistence, undo support, and stage progression. SwipeCard component uses Framer Motion drag with 40% threshold, visual rotation during drag, and left/right indicator overlays. Back cards are not draggable.
  </done>
</task>

</tasks>

<verification>
1. `npm ls framer-motion` shows framer-motion@11.x installed
2. `npx tsc --noEmit` compiles without errors
3. `src/types/swipe.ts` exports SwipeStage, SwipeCardData, SwipeFlowState, SwipeSelection, StageConfig
4. `src/lib/swipe-data.ts` exports occasionCards (6), moodCards (5), genreCards (5), voiceCards (5), STAGE_ORDER (4), STAGE_CONFIG (4)
5. `src/lib/swipe-state.ts` exports useSwipeState with handleSwipe, undo, reset, canUndo, isSwipeComplete, progress
6. `src/components/swipe/SwipeCard.tsx` exports SwipeCard with drag="x", 40% threshold logic, visual feedback
7. Card data values align with existing elevenlabs.ts schema values for occasion, mood, genre
</verification>

<success_criteria>
- Framer Motion installed and importable
- Type system covers all swipe flow state, card data, and stage configuration
- Card data arrays align with existing customization schema values
- useSwipeState hook persists to sessionStorage, supports undo, tracks stage progression
- SwipeCard uses Framer Motion drag with 40% threshold and visual feedback during drag
- All files pass TypeScript compilation
</success_criteria>

<output>
After completion, create `.planning/phases/03-swipe-builder/03-01-SUMMARY.md`
</output>
