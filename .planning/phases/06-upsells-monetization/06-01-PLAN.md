---
phase: 06-upsells-monetization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/003_add_bundles.sql
  - src/types/database.ts
  - src/lib/stripe.ts
  - src/lib/bundles/types.ts
  - src/lib/bundles/pricing.ts
  - src/app/api/webhook/route.ts
autonomous: true
user_setup:
  - service: supabase
    why: "New bundles table requires manual migration"
    dashboard_config:
      - task: "Run 003_add_bundles.sql in SQL Editor"
        location: "Supabase Dashboard -> SQL Editor"

must_haves:
  truths:
    - "Bundles table exists in database with quantity tracking and RLS policies"
    - "Stripe checkout helper supports base, upsell, and bundle order types with dynamic pricing"
    - "Webhook handler routes bundle purchases to create bundle credit records instead of triggering generation"
    - "Webhook handler routes upsell purchases to generate a single variant linked to original order"
    - "All pricing is validated server-side with fixed constants (never client-calculated)"
    - "Bundle credit redemption integration into base checkout flow is planned in Plan 03 (06-03), which creates the redemption module and wires it into the order flow"
  artifacts:
    - path: "supabase/migrations/003_add_bundles.sql"
      provides: "Bundles table with RLS, CHECK constraints, indexes"
      contains: "CREATE TABLE bundles"
    - path: "src/types/database.ts"
      provides: "Bundle and pricing TypeScript types"
      contains: "Bundle"
    - path: "src/lib/stripe.ts"
      provides: "Updated checkout helper supporting upsell/bundle order types with metadata"
      contains: "orderType"
    - path: "src/lib/bundles/types.ts"
      provides: "Bundle tier definitions and type exports"
      contains: "BundleTier"
    - path: "src/lib/bundles/pricing.ts"
      provides: "Server-side pricing constants and validation"
      contains: "UPSELL_PRICE"
    - path: "src/app/api/webhook/route.ts"
      provides: "Branching logic for base/upsell/bundle order types"
      contains: "orderType"
  key_links:
    - from: "src/lib/stripe.ts"
      to: "Stripe API"
      via: "price_data with dynamic amount"
      pattern: "price_data.*unit_amount"
    - from: "src/app/api/webhook/route.ts"
      to: "supabase bundles table"
      via: "insert on bundle purchase"
      pattern: "from.*bundles.*insert"
    - from: "src/lib/bundles/pricing.ts"
      to: "src/lib/stripe.ts"
      via: "pricing constants used in checkout validation"
      pattern: "UPSELL_PRICE|BUNDLE_TIERS"
---

<objective>
Create the database schema, pricing infrastructure, and webhook routing needed for both the +1 variant upsell and bundle credit system.

Purpose: Foundation layer that both upsell flows (Plans 02 and 03) depend on. Establishes the bundles table, server-side pricing constants, updated Stripe checkout helper with order type routing, and webhook branching logic.

Output: Migration file, pricing constants module, updated Stripe helper, updated webhook handler, TypeScript types.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-upsells-monetization/06-RESEARCH.md
@.planning/phases/02-base-payment-and-pricing/02-01-SUMMARY.md
@src/lib/stripe.ts
@src/app/api/webhook/route.ts
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bundles migration, pricing constants, and TypeScript types</name>
  <files>
    supabase/migrations/003_add_bundles.sql
    src/lib/bundles/types.ts
    src/lib/bundles/pricing.ts
    src/types/database.ts
  </files>
  <action>
    1. Create `supabase/migrations/003_add_bundles.sql`:
       - CREATE TABLE bundles with columns: id (UUID PK default gen_random_uuid()), user_id (UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE), order_id (UUID NOT NULL REFERENCES orders(id) ON DELETE CASCADE), bundle_tier (TEXT NOT NULL CHECK IN ('3-pack', '5-pack', '10-pack')), quantity_purchased (INTEGER NOT NULL CHECK > 0), quantity_remaining (INTEGER NOT NULL CHECK >= 0), purchased_at (TIMESTAMPTZ DEFAULT NOW()), expires_at (TIMESTAMPTZ nullable, NULL = never expires)
       - Add CONSTRAINT remaining_lte_purchased CHECK (quantity_remaining <= quantity_purchased)
       - Create indexes on user_id and order_id
       - Enable RLS with policies: "Users can view own bundles" (SELECT for authenticated WHERE auth.uid() = user_id), "Service role can manage bundles" (ALL for service_role USING true)
       - Also add parent_order_id column to orders table (UUID nullable, REFERENCES orders(id)) for linking upsell orders to their parent. Add index on parent_order_id.

    2. Create `src/lib/bundles/types.ts`:
       - Export BundleTier interface: { id: string, name: string, quantity: number, price: number (pence), perSongPrice: number (pence), savings: number (percentage), popular?: boolean }
       - Export BundleRecord interface matching database schema: { id: string, user_id: string, order_id: string, bundle_tier: string, quantity_purchased: number, quantity_remaining: number, purchased_at: string, expires_at: string | null }
       - Export BundleBalance interface: { totalRemaining: number, bundles: Array<{ id: string, tier: string, remaining: number, purchased: number, purchasedAt: string }> }

    3. Create `src/lib/bundles/pricing.ts`:
       - Export BASE_PRICE = 799 (pence, £7.99)
       - Export UPSELL_PRICE = 499 (pence, £4.99 -- 37% discount per research recommendation)
       - Export BUNDLE_TIERS array of BundleTier: 3-pack (£19.99, £6.66/song, 17% savings), 5-pack (£29.99, £6.00/song, 25% savings, popular: true), 10-pack (£49.99, £5.00/song, 37% savings)
       - Export validateUpsellPrice(amount: number): boolean -- returns true only if amount === UPSELL_PRICE
       - Export validateBundlePrice(tierId: string, amount: number): boolean -- finds tier by id and checks amount matches tier.price
       - Export getBundleTier(tierId: string): BundleTier | undefined

    4. Update `src/types/database.ts`:
       - Add Bundle interface matching bundles table columns
       - Add parent_order_id to Order/OrderRow interfaces (nullable string)
       - Ensure OrderType includes 'base' | 'upsell' | 'bundle' (should already exist from Phase 2)
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm TypeScript compiles.
    Verify migration file contains CREATE TABLE bundles, ALTER TABLE orders ADD parent_order_id, RLS policies, and indexes.
    Verify pricing.ts exports UPSELL_PRICE = 499 and BUNDLE_TIERS with 3 entries.
  </verify>
  <done>
    Bundles migration ready for manual execution. Pricing constants centralized server-side. TypeScript types match new schema. All prices hardcoded (not client-calculated).
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Stripe checkout helper and webhook handler for upsell/bundle routing</name>
  <files>
    src/lib/stripe.ts
    src/app/api/webhook/route.ts
  </files>
  <action>
    1. Update `src/lib/stripe.ts` createCheckoutSession function:
       - Add optional parameters: amount (default BASE_PRICE from pricing.ts), orderType (default 'base'), successUrl (optional override), cancelUrl (optional override), metadata (Record<string, string> for additional metadata like originalOrderId, bundleTier, quantity)
       - Use inline price_data with dynamic unit_amount (not Price IDs) to support variable pricing
       - Set product_data name/description based on orderType: base = "Personalized Song Package" / "3 AI-generated song variants", upsell = "Additional Song Variant" / "1 more variant for your order", bundle = "Song Bundle - {bundleTier}" / "{quantity} song credits"
       - Merge additional metadata into session.metadata and payment_intent_data.metadata (spread ...metadata after standard fields)
       - Allow success_url and cancel_url overrides (default to existing URLs if not provided)

    2. Update `src/app/api/webhook/route.ts` checkout.session.completed handler:
       - After creating the order record, branch based on orderType from session.metadata:
       - If orderType === 'bundle': Insert row into bundles table with user_id, order_id, bundle_tier (from metadata), quantity_purchased (from metadata), quantity_remaining (same as purchased). Do NOT trigger Inngest generation. Return early.
       - If orderType === 'upsell': Set parent_order_id on the new order (from metadata.originalOrderId). Trigger Inngest generation with variantCount: 1 and the next available variant_number (4, since base order has 1-3). Pass originalOrderId in event data so generation function can associate variant with correct order.
       - If orderType === 'base' (default): Existing behavior -- trigger Inngest generation with variantCount: 3.
       - Use service_role Supabase client for all database operations (existing pattern).
       - NOTE: Bundle credit redemption (checking existing credits before Stripe redirect on new base orders) is NOT handled here. This plan creates the infrastructure for purchasing bundles. The redemption module (redeemBundleCredit, getUserBundleBalance) and its integration into the base checkout flow (checking credits in src/actions/checkout.ts before redirecting to Stripe) is implemented in Plan 03 (06-03).
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm TypeScript compiles.
    Verify stripe.ts accepts orderType, amount, and metadata parameters.
    Verify webhook route.ts has three distinct branches for 'base', 'upsell', and 'bundle' order types.
  </verify>
  <done>
    Stripe checkout helper supports dynamic pricing for all order types. Webhook correctly routes bundle purchases to credit creation (no generation) and upsell purchases to single-variant generation linked to parent order.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. Migration file contains: CREATE TABLE bundles, ALTER TABLE orders ADD parent_order_id, RLS policies, CHECK constraints, indexes
3. Pricing constants are server-side only (no client imports needed)
4. Stripe helper accepts orderType parameter and uses inline price_data
5. Webhook handler has branching logic for base/upsell/bundle order types
6. Bundle purchases create credit records without triggering generation
7. Upsell purchases trigger single-variant generation with parent_order_id linking
</verification>

<success_criteria>
- Bundles table migration ready for manual execution in Supabase SQL Editor
- All pricing hardcoded in server-side constants (UPSELL_PRICE = 499, BUNDLE_TIERS with 3 tiers)
- Stripe checkout helper supports base (£7.99), upsell (£4.99), and bundle (variable) order types
- Webhook handler correctly routes each order type to appropriate processing (generation vs credit creation)
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-upsells-monetization/06-01-SUMMARY.md`
</output>
