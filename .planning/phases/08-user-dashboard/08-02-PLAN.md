---
phase: 08-user-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/components/dashboard/SongCard.tsx
  - src/components/dashboard/OrderRow.tsx
  - src/components/dashboard/OccasionCard.tsx
  - src/components/dashboard/EmptyState.tsx
  - src/components/dashboard/Pagination.tsx
  - src/app/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can view all previously created songs with dates and recipient names"
    - "User can replay any song via expand/collapse audio player"
    - "User can re-download any song with a freshly generated signed URL"
    - "User can view order/purchase history with dates, amounts, and order types"
    - "User can see tracked occasion dates and upcoming reminders with days-until count"
    - "Empty states guide users to create their first song"
    - "Pagination controls allow navigating through song and order history"
  artifacts:
    - path: "src/components/dashboard/SongCard.tsx"
      provides: "Song card with expand/collapse audio player and download button"
    - path: "src/components/dashboard/OrderRow.tsx"
      provides: "Order history row with status badge, amount, and order type"
    - path: "src/components/dashboard/OccasionCard.tsx"
      provides: "Occasion date card with days-until countdown"
    - path: "src/components/dashboard/EmptyState.tsx"
      provides: "Reusable empty state component with icon, title, description, CTA"
    - path: "src/components/dashboard/Pagination.tsx"
      provides: "Pagination controls with page numbers and prev/next"
    - path: "src/app/dashboard/page.tsx"
      provides: "Complete dashboard page with tabs for songs, orders, and occasions"
  key_links:
    - from: "src/app/dashboard/page.tsx"
      to: "useSongHistory, useOrderHistory, useOccasions"
      via: "React Query hooks imported from @/lib/hooks"
      pattern: "useSongHistory|useOrderHistory|useOccasions"
    - from: "src/components/dashboard/SongCard.tsx"
      to: "/api/songs/[id]/stream"
      via: "Audio player loads stream when expanded"
      pattern: "api/songs.*stream"
    - from: "src/components/dashboard/SongCard.tsx"
      to: "useDownloadSong"
      via: "Download button triggers mutation"
      pattern: "useDownloadSong"
---

<objective>
Build the complete dashboard UI with song history (playback + download), order history, occasion tracking, and shared components (empty states, pagination).

Purpose: Replace the existing stub dashboard with a full-featured user dashboard that satisfies all DASH requirements. Users can review their song history, replay/download songs, view purchases, and see upcoming occasions.

Output: 5 dashboard components, 1 rewritten dashboard page
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-user-dashboard/08-RESEARCH.md
@.planning/phases/08-user-dashboard/08-01-SUMMARY.md
@.planning/phases/05-song-delivery/05-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reusable dashboard components</name>
  <files>
    src/components/dashboard/EmptyState.tsx
    src/components/dashboard/Pagination.tsx
    src/components/dashboard/OccasionCard.tsx
    src/components/dashboard/OrderRow.tsx
  </files>
  <action>
    Create four reusable dashboard components. All are 'use client' components.

    **EmptyState.tsx** (reusable across all sections):
    - Props: `icon` (ReactNode), `title` (string), `description` (string), `action` (optional ReactNode for CTA button)
    - Centered layout with icon at top, title (text-lg font-medium), description (text-gray-500), action button below
    - Padding: p-12 text-center
    - Use in all empty sections (songs, orders, occasions)

    **Pagination.tsx** (reusable for songs and orders):
    - Props: `page` (number), `pageCount` (number), `onPageChange` (callback: (page: number) => void)
    - Show "Previous" and "Next" buttons with disabled states at boundaries
    - Show "Page X of Y" text between buttons
    - Only render if pageCount > 1
    - Style: flex justify-center gap-2, buttons with purple-to-pink gradient when active, gray when disabled
    - Buttons use `disabled` attribute and reduced opacity when at boundary

    **OccasionCard.tsx**:
    - Props: `recipientName` (string), `occasion` (string), `date` (string, pre-formatted), `daysUntil` (number)
    - Card layout with recipient name as title, occasion type below, formatted date, and days-until badge
    - Days-until badge: green for 30+ days, yellow for 7-30 days, red for <7 days
    - Badge text: "{N} days away" or "Tomorrow" for 1 day or "Today" for 0 days
    - Format occasion with capitalize and remove hyphens (follow formatOccasion pattern from Phase 7: replace /-/g with ' ', capitalize first letter of each word)
    - Glass-morphism card style matching app theme (bg-white/80 backdrop-blur-sm rounded-xl shadow-sm border border-gray-100)

    **OrderRow.tsx**:
    - Props: `orderId` (string), `status` (string), `amount` (number, in pence), `orderType` (string), `date` (string), `recipientName` (string | null), `occasion` (string | null)
    - Row layout for use in a list (not table -- simple lists per research YAGNI)
    - Show: date (formatted), recipient name (or "N/A"), order type badge (base/upsell/bundle with different colors), status badge (completed=green, paid/generating=blue, failed=red), amount in GBP
    - Order type displayed with capitalize: "Base" / "Upsell" / "Bundle"
    - Amount formatted: `Â£${(amount / 100).toFixed(2)}`
    - Use format from date-fns for date: `format(new Date(date), 'MMM d, yyyy')`
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no TypeScript errors.
    Confirm all 4 component files exist under src/components/dashboard/.
    Verify each file has 'use client' directive.
  </verify>
  <done>
    Four reusable dashboard components created: EmptyState (generic empty state), Pagination (page controls), OccasionCard (upcoming date with countdown), OrderRow (purchase history entry). All typed, styled with app theme.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SongCard component and rewrite dashboard page</name>
  <files>
    src/components/dashboard/SongCard.tsx
    src/app/dashboard/page.tsx
  </files>
  <action>
    **SongCard.tsx** ('use client'):
    - Props: song object with id, recipientName, occasion, genre, mood, createdAt, senderName
    - Expand/collapse pattern for lazy audio loading (only load player when expanded)
    - Collapsed state: shows recipient name, occasion (formatted: capitalize, remove hyphens), genre, date (format with date-fns), and "Play" button
    - Expanded state: mounts audio player fetching from `/api/songs/${song.id}/stream`, plus "Download" button using useDownloadSong hook
    - Audio player: use react-h5-audio-player (already installed from Phase 5) with same purple-to-pink gradient styling
    - When expanded, fetch audio as blob via `/api/songs/${song.id}/stream`, create blob URL, pass to AudioPlayer src
    - Cleanup: revoke blob URL on collapse or unmount via useEffect cleanup function
    - Download button: use useDownloadSong() mutation, show "Downloading..." when isPending, disable button during download
    - Card style: bg-white rounded-xl shadow-sm border border-gray-100 p-4, gradient icon on left side
    - Import AudioPlayer from 'react-h5-audio-player' and its CSS

    **Dashboard page rewrite** (src/app/dashboard/page.tsx):
    - Complete rewrite of existing stub dashboard
    - Make it a 'use client' component (needs React Query hooks and useState)
    - Auth check: use useEffect with Supabase browser client to check auth, redirect to /auth/login if not authenticated
    - Three tabbed sections: "My Songs", "Orders", "Occasions"
    - Tab bar with purple gradient underline on active tab

    **My Songs tab (default active):**
    - Use useSongHistory(page) hook
    - Map songs to SongCard components
    - Show loading skeletons (3 skeleton cards with animate-pulse) when isLoading
    - Show EmptyState when no songs (icon: music note, title: "No songs yet", description: "Create your first personalized song!", CTA: Link to /customize)
    - Pagination component below list

    **Orders tab:**
    - Use useOrderHistory(page) hook
    - Map orders to OrderRow components
    - Show loading skeletons when isLoading
    - Show EmptyState when no orders (title: "No orders yet", description: "Your purchase history will appear here.", CTA: Link to /pricing)
    - Pagination component below list

    **Occasions tab:**
    - Use useOccasions() hook (no pagination)
    - Map occasions to OccasionCard components
    - Show loading skeleton when isLoading
    - Show EmptyState when no occasions (title: "No upcoming occasions", description: "Create songs for special dates to track them here.")
    - No pagination needed

    **Page header:**
    - Keep existing gradient "My Dashboard" title and user email
    - Keep sign out button (form action="/auth/signout")
    - Add quick stats row: total songs count, total orders count, total spent (from order history data)

    **Important implementation notes:**
    - Each tab maintains its own page state (songPage, orderPage) so switching tabs preserves position
    - Tab state managed via useState<'songs' | 'orders' | 'occasions'>
    - Supabase browser client import: `import { createBrowserClient } from '@supabase/ssr'`
    - Audio player CSS import: `import 'react-h5-audio-player/lib/styles.css'`
    - Use the established purple-to-pink gradient theme throughout
    - Loading skeletons: div with bg-gray-200 animate-pulse rounded-xl h-24 w-full
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no TypeScript errors.
    Confirm SongCard.tsx exists at src/components/dashboard/SongCard.tsx.
    Confirm dashboard page.tsx has been rewritten (should contain 'use client' directive).
    Verify dashboard page imports useSongHistory, useOrderHistory, useOccasions hooks.
    Verify SongCard imports useDownloadSong and react-h5-audio-player.
    Verify SongCard has blob URL cleanup in useEffect.
  </verify>
  <done>
    SongCard component with expand/collapse audio player and download button. Dashboard page fully rewritten with three tabbed sections (songs, orders, occasions), React Query data fetching, pagination, loading skeletons, and empty states. Users can view song history, replay/download songs, review purchases, and see upcoming occasions.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. All 5 component files exist under src/components/dashboard/
3. Dashboard page.tsx is a 'use client' component with tabbed layout
4. SongCard expands to show audio player and download button
5. SongCard cleans up blob URLs on collapse/unmount
6. OrderRow shows order type (base/upsell/bundle) and formatted amount
7. OccasionCard shows days-until countdown with color-coded badges
8. EmptyState shows CTA linking to /customize or /pricing
9. Pagination renders only when pageCount > 1
10. Tab switching preserves pagination state per section
</verification>

<success_criteria>
- Complete dashboard page with 3 tabbed sections replacing existing stub
- Users can view song history with recipient names, dates, and occasions
- Users can expand any song card to replay via audio player
- Users can download any song with fresh signed URL via download button
- Users can view order/purchase history with dates, amounts, and order types
- Users can see upcoming occasion dates with days-until countdown
- Empty states guide users to relevant actions when no data exists
- Pagination allows navigating through large song/order histories
</success_criteria>

<output>
After completion, create `.planning/phases/08-user-dashboard/08-02-SUMMARY.md`
</output>
