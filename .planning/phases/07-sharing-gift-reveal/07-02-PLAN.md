---
phase: 07-sharing-gift-reveal
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/components/share/GiftReveal.tsx
  - src/components/share/ShareButtons.tsx
  - src/components/share/CopyLinkButton.tsx
  - src/app/share/[token]/page.tsx
  - src/app/api/share/[token]/stream/route.ts
  - src/app/song/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Recipients see a cinematic gift reveal animation before hearing the song"
    - "Recipients can skip the animation after 2 seconds to jump straight to the song"
    - "Recipients can play the song directly on the share page without logging in"
    - "Share page shows social share buttons for WhatsApp, Facebook, Twitter/X, and a copy link button"
    - "Song delivery page (/song/[id]) shows a share link section so the sender can share their song"
  artifacts:
    - path: "src/components/share/GiftReveal.tsx"
      provides: "Cinematic gift reveal animation with Framer Motion"
      exports: ["GiftReveal"]
    - path: "src/components/share/ShareButtons.tsx"
      provides: "Social share buttons for WhatsApp, Facebook, Twitter/X"
      exports: ["ShareButtons"]
    - path: "src/components/share/CopyLinkButton.tsx"
      provides: "Clipboard API copy link button with fallback"
      exports: ["CopyLinkButton"]
    - path: "src/app/api/share/[token]/stream/route.ts"
      provides: "Public audio streaming endpoint for share page (no auth)"
      exports: ["GET"]
  key_links:
    - from: "src/components/share/GiftReveal.tsx"
      to: "Framer Motion AnimatePresence"
      via: "Multi-stage animation (box -> revealing -> revealed with audio player)"
      pattern: "AnimatePresence.*stage.*box.*revealed"
    - from: "src/app/share/[token]/page.tsx"
      to: "src/components/share/GiftReveal.tsx"
      via: "Server component passes song data props to client component"
      pattern: "GiftReveal.*recipientName.*message.*variantId"
    - from: "src/app/api/share/[token]/stream/route.ts"
      to: "song_variants table"
      via: "Service role query by share_token for public audio access"
      pattern: "createServerSupabaseClient.*share_token.*storage_path"
    - from: "src/app/song/[id]/page.tsx"
      to: "src/lib/share/generateShareUrl.ts"
      via: "Import generateShareUrl to build shareable link for sender"
      pattern: "generateShareUrl.*shareToken"
---

<objective>
Build the interactive client-side experience for the share page: cinematic gift reveal animation, audio playback, social share buttons, and integrate sharing into the existing song delivery page.

Purpose: This plan brings the share page to life. The gift reveal creates an emotional moment for recipients, the audio player lets them hear the song immediately, social buttons enable viral sharing, and the song delivery page integration lets senders easily share their songs.

Output: Gift reveal animation component, social share buttons, public audio streaming endpoint, updated share page and song delivery page.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-sharing-gift-reveal/07-RESEARCH.md
@.planning/phases/07-sharing-gift-reveal/07-01-SUMMARY.md
@src/components/song/SongPlayer.tsx
@src/app/api/songs/[id]/stream/route.ts
@src/app/song/[id]/page.tsx
@src/lib/share/generateShareUrl.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gift reveal animation, public audio stream, and update share page</name>
  <files>
    src/components/share/GiftReveal.tsx
    src/app/api/share/[token]/stream/route.ts
    src/app/share/[token]/page.tsx
  </files>
  <action>
**Public audio streaming endpoint:**
Create `src/app/api/share/[token]/stream/route.ts` -- a public (no auth) audio streaming endpoint for the share page. This is necessary because the existing `/api/songs/[id]/stream` requires authentication. The share stream validates by share_token instead.

- Accept `{ params }: { params: { token: string } }`.
- Validate UUID format (same regex as existing endpoints).
- Use `createServerSupabaseClient()` (service role, no auth needed).
- Query `song_variants` for: `storage_path, generation_status` where `share_token = token`, `selected = true`, `generation_status = 'complete'`.
- If not found or error, return 404 `{ error: 'Song not found' }`.
- Generate signed URL with 2-hour expiry (7200s) from Supabase Storage `songs` bucket.
- Fetch audio from signed URL, convert to ArrayBuffer.
- Return as `new NextResponse(audioBuffer, { ... })` with headers:
  - `Content-Type: audio/mpeg`
  - `Content-Disposition: inline`
  - `Cache-Control: public, max-age=3600` (public cache OK since share links are public)
  - `Accept-Ranges: bytes`
- Follow the exact same proxy pattern as `src/app/api/songs/[id]/stream/route.ts` but replace auth check with share_token validation.

**GiftReveal client component:**
Create `src/components/share/GiftReveal.tsx` with `'use client'` directive.

Interface:
```typescript
interface GiftRevealProps {
  recipientName: string
  message: string
  shareToken: string  // Used to build audio stream URL
  occasion: string
}
```

State:
- `stage: 'box' | 'revealing' | 'revealed'` -- starts at 'box'.
- `showSkip: boolean` -- starts false, becomes true after 2 seconds via useEffect timer.
- `audioUrl: string | null` -- blob URL for audio, loaded after reveal.

Animation stages (using Framer Motion's AnimatePresence with mode="wait"):

**Stage: 'box'**
- Dark gradient background (`min-h-screen bg-gradient-to-b from-gray-900 via-purple-900/20 to-gray-900`).
- Centered gift box emoji (text-8xl) with floating animation (`animate: { y: [0, -10, 0] }`, `transition: { duration: 1.5, repeat: Infinity, ease: "easeInOut" }`).
- Heading: "{recipientName}, you have received a gift!" (text-3xl md:text-4xl font-bold text-white).
- "Open Your Gift" button (gradient from-purple-500 to-pink-500, rounded-full, px-8 py-4, text-xl font-semibold) with `whileHover={{ scale: 1.05 }}` and `whileTap={{ scale: 0.95 }}`.
- Clicking button sets stage to 'revealing'.
- After 2 seconds (useEffect timer), show a subtle "Skip to song" text link below the button (text-white/50, underline, text-sm). Clicking it jumps straight to 'revealed' stage.

**Stage: 'revealing'**
- Ribbon emoji (text-8xl) that spins and shrinks: `animate: { opacity: 0, rotateZ: 720, scale: [1, 1.2, 0] }`, `transition: { duration: 1.5, ease: "easeInOut" }`.
- Use `onAnimationComplete` callback (NOT setTimeout) to transition to 'revealed' stage.

**Stage: 'revealed'**
- Container with staggered fade-in (`initial: { opacity: 0, y: 30 }`, `animate: { opacity: 1, y: 0 }`).
- Music note emoji (text-6xl) fading in.
- "Your Personalized Song" heading (text-4xl md:text-5xl font-bold, gradient text from-purple-400 to-pink-400).
- Personal message in a glass-morphism card (`bg-white/5 backdrop-blur rounded-2xl p-8`) with italic text.
- Audio player section: Fetch audio blob from `/api/share/${shareToken}/stream` in a useEffect when stage becomes 'revealed'. Create blob URL. Render the existing `SongPlayer` component from `@/components/song/SongPlayer` passing audioUrl and isLoading.
- Clean up blob URL on unmount (same pattern as useSongData hook: `URL.revokeObjectURL`).
- SongSwipe branding at bottom.

**Important animation notes:**
- Use `onAnimationComplete` on the revealing stage motion div to trigger stage transition (per research anti-pattern: avoid setTimeout for animation sequencing).
- Only animate `transform` and `opacity` for GPU acceleration.
- The audio player import means this component will need react-h5-audio-player CSS. Since SongPlayer already handles its own global styles, this should work without additional CSS imports.

**Update share page:**
Modify `src/app/share/[token]/page.tsx` (created in Plan 01):
- Import `GiftReveal` from `@/components/share/GiftReveal`.
- Replace the placeholder server-rendered content with the GiftReveal client component, passing: `recipientName`, `message` (the derived personal message string), `shareToken` (the token from params), `occasion`.
- Keep the server component structure (data fetching, notFound, generateMetadata) from Plan 01.
- Add a `<div>` placeholder below GiftReveal for ShareButtons (Task 2 will add the actual component).
- The page should NOT include the Header component. Check if the root layout always renders Header -- if so, create a share route group `(share)` with its own layout.tsx that omits the Header OR simply hide the header via a conditional. Looking at existing code: the Header component in `src/components/Header.tsx` has conditional hiding for certain paths (02-02 decision: "Header hidden on /checkout paths"). Follow the same pattern: add `/share` paths to the Header's hidden paths list. Do NOT modify the Header in this plan -- instead, note that the share page should work with or without the header, and the dark background will make it feel like a standalone page regardless.
  </action>
  <verify>
Run `npx tsc --noEmit` from project root. Verify:
- No TypeScript errors.
- `src/components/share/GiftReveal.tsx` exists with 'use client' directive and named export.
- `src/app/api/share/[token]/stream/route.ts` exists with GET export.
- `src/app/share/[token]/page.tsx` imports and renders GiftReveal.
- GiftReveal imports SongPlayer from `@/components/song/SongPlayer`.
  </verify>
  <done>
Gift reveal animation plays a 3-stage cinematic sequence (gift box, ribbon unwrap, revealed content with audio player). Skip button appears after 2 seconds. Audio streams from a public endpoint that validates by share_token without requiring authentication. Share page server component passes all necessary data to the GiftReveal client component.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create social share buttons, copy link, and add sharing to song delivery page</name>
  <files>
    src/components/share/ShareButtons.tsx
    src/components/share/CopyLinkButton.tsx
    src/app/share/[token]/page.tsx
    src/app/song/[id]/page.tsx
  </files>
  <action>
**Install react-share:**
Run `npm install react-share` before creating components.

**CopyLinkButton component:**
Create `src/components/share/CopyLinkButton.tsx` with `'use client'` directive.

Interface:
```typescript
interface CopyLinkButtonProps {
  url: string
}
```

State: `copied: boolean` (default false).

Implementation:
- `handleCopy` async function:
  - Try modern Clipboard API first: `navigator.clipboard?.writeText(url)`.
  - Fallback: Create hidden textarea, select, `document.execCommand('copy')`, remove textarea.
  - On success: set `copied = true`, setTimeout to reset after 2 seconds.
  - On error: `console.error('Failed to copy link:', error)`.
- Render a button with:
  - Dimensions matching react-share icon buttons (w-12 h-12 rounded-full).
  - Dark background (bg-gray-700 hover:bg-gray-600).
  - Show checkmark icon when copied, link/copy icon otherwise (use an SVG path for the copy icon, similar to what's in the research).
  - Title attribute: "Copy link".

**ShareButtons component:**
Create `src/components/share/ShareButtons.tsx` with `'use client'` directive.

Interface:
```typescript
interface ShareButtonsProps {
  url: string
  title: string
  recipientName: string
  occasion: string
}
```

Implementation:
- Import from `react-share`: `WhatsappShareButton`, `WhatsappIcon`, `FacebookShareButton`, `FacebookIcon`, `TwitterShareButton`, `XIcon` (note: Twitter rebranded to X, use XIcon).
- Import `CopyLinkButton` from `./CopyLinkButton`.
- Build share text: `"Check out this personalized ${occasion} song for ${recipientName}!"` (no emoji in the share text -- keep it clean for all platforms).
- Render a section:
  - "Share this gift" heading (text-xl font-semibold text-white).
  - Row of 4 buttons (flex gap-4 items-center justify-center):
    1. WhatsappShareButton with WhatsappIcon (size={48} round).
    2. FacebookShareButton with FacebookIcon (size={48} round). Use `hashtag="#SongSwipe"`.
    3. TwitterShareButton with XIcon (size={48} round). Pass `title={shareText}`.
    4. CopyLinkButton with url prop.
  - Subtle helper text below: "Share this special gift with friends and family" (text-sm text-gray-400).

**Update share page (add ShareButtons):**
Modify `src/app/share/[token]/page.tsx`:
- Import `ShareButtons` from `@/components/share/ShareButtons`.
- After the GiftReveal component, add a section (container with padding) rendering ShareButtons with:
  - `url={shareUrl}` (built from generateShareUrl).
  - `title={`${occasion} Song for ${recipientName}`}`.
  - `recipientName` and `occasion` props.

**Update song delivery page (add share section for sender):**
Modify `src/app/song/[id]/page.tsx`:
- Import `generateShareUrl` from `@/lib/share/generateShareUrl`.
- Import `CopyLinkButton` from `@/components/share/CopyLinkButton`.
- The song data already includes `shareToken` from the `/api/songs/[id]` metadata endpoint (confirmed in the route.ts response).
- After the Download MP3 button and before the SongDetails section, add a "Share Your Song" section:
  - Only render if `song.shareToken` exists.
  - Build `shareUrl = generateShareUrl(song.shareToken)`.
  - Show a section with:
    - Divider line (border-t border-purple-500/20).
    - "Share Your Song" heading (text-xl font-semibold text-white text-center).
    - Share URL displayed in a truncated text field (bg-white/5 rounded-lg p-3, text-white/70 text-sm, overflow-hidden text-ellipsis).
    - CopyLinkButton next to the URL display (inline-flex layout).
    - Brief text: "Send this link to {recipientName} for a special gift reveal experience" (text-sm text-gray-400).
  </action>
  <verify>
Run `npx tsc --noEmit` from project root. Verify:
- No TypeScript errors.
- `react-share` is in package.json dependencies.
- `src/components/share/ShareButtons.tsx` exists with named export.
- `src/components/share/CopyLinkButton.tsx` exists with named export.
- `src/app/share/[token]/page.tsx` imports and renders both GiftReveal and ShareButtons.
- `src/app/song/[id]/page.tsx` imports CopyLinkButton and generateShareUrl.
  </verify>
  <done>
Share page shows WhatsApp, Facebook, Twitter/X share buttons and a copy link button below the gift reveal. Song delivery page (/song/[id]) shows a share link section with the URL and copy button so senders can share their song. react-share library installed and integrated.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `react-share` is listed in package.json dependencies
3. Gift reveal animation has 3 stages (box, revealing, revealed) using Framer Motion
4. Skip button appears after 2 seconds of animation
5. Audio plays on share page via `/api/share/[token]/stream` without authentication
6. Social share buttons render for WhatsApp, Facebook, Twitter/X
7. Copy link button copies share URL to clipboard
8. Song delivery page shows share link section with copy button
9. Share page renders both GiftReveal and ShareButtons
10. Public audio endpoint validates share_token and only serves selected+complete variants
</verification>

<success_criteria>
- Recipients experience a cinematic 3-stage gift reveal before hearing the song
- Animation is skippable after 2 seconds
- Audio plays on the share page without login
- Social share buttons work for WhatsApp, Facebook, Twitter/X
- Copy link copies the permanent share URL
- Senders can find and copy their share link on the song delivery page
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-sharing-gift-reveal/07-02-SUMMARY.md`
</output>
