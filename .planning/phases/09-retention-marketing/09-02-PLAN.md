---
phase: 09-retention-marketing
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/lib/inngest/functions/check-anniversaries.ts
  - src/lib/inngest/functions/send-reminder-email.ts
  - src/lib/emails/anniversary-reminder.tsx
  - src/app/api/inngest/route.ts
autonomous: true

must_haves:
  truths:
    - "System checks for upcoming anniversaries daily via cron job"
    - "Individual reminder emails are scheduled and sent 7 days before each anniversary"
    - "Reminder email includes 'continue the story' CTA linking to /customize with pre-filled occasion"
    - "Opt-out preferences are checked at send time, not schedule time"
    - "Duplicate reminders are prevented via Inngest event ID deduplication"
    - "Only users active within 18 months receive reminders"
  artifacts:
    - path: "src/lib/inngest/functions/check-anniversaries.ts"
      provides: "Daily cron function querying upcoming occasion anniversaries"
      exports: ["checkAnniversaries"]
    - path: "src/lib/inngest/functions/send-reminder-email.ts"
      provides: "Event-triggered function that sleeps until send date then sends email"
      exports: ["sendReminderEmail"]
    - path: "src/lib/emails/anniversary-reminder.tsx"
      provides: "React Email template with CAN-SPAM compliant footer"
      exports: ["AnniversaryReminderEmail"]
    - path: "src/app/api/inngest/route.ts"
      provides: "Updated Inngest serve config registering both new functions"
      contains: "checkAnniversaries"
  key_links:
    - from: "src/lib/inngest/functions/check-anniversaries.ts"
      to: "email/anniversary-reminder.requested"
      via: "inngest.send() for each upcoming anniversary"
      pattern: "inngest\\.send.*anniversary-reminder"
    - from: "src/lib/inngest/functions/send-reminder-email.ts"
      to: "src/lib/emails/anniversary-reminder.tsx"
      via: "React Email template rendered in Resend send call"
      pattern: "AnniversaryReminderEmail"
    - from: "src/lib/inngest/functions/send-reminder-email.ts"
      to: "email_preferences table"
      via: "Supabase query to check opt-out before sending"
      pattern: "email_preferences.*global_unsubscribe"
    - from: "src/app/api/inngest/route.ts"
      to: "src/lib/inngest/functions/check-anniversaries.ts"
      via: "functions array in serve()"
      pattern: "checkAnniversaries"
---

<objective>
Build the anniversary reminder engine: a daily Inngest cron that finds upcoming anniversaries, schedules individual reminder emails via event-driven functions, and sends CAN-SPAM compliant emails with "continue the story" CTAs via Resend + React Email.

Purpose: Satisfies RETAIN-02 (send email reminders before anniversary) and RETAIN-03 (include "continue the story" CTA). This is the core retention loop that drives repeat song creation.
Output: Two Inngest functions (cron checker + email sender), one React Email template, updated Inngest route registration.
</objective>

<execution_context>
@/Users/jamesshallcrass/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamesshallcrass/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-retention-marketing/09-RESEARCH.md
@src/lib/inngest/client.ts
@src/lib/inngest/functions/generate-song.ts
@src/app/api/inngest/route.ts
@src/lib/supabase.ts
@src/types/database.ts
@src/types/email-preferences.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @react-email/components and create email template</name>
  <files>
    src/lib/emails/anniversary-reminder.tsx
  </files>
  <action>
    1. Run `npm install @react-email/components resend` to add React Email components and Resend SDK.

    2. Create `src/lib/emails/anniversary-reminder.tsx`:
       - Import Html, Head, Body, Container, Section, Text, Button, Link, Hr, Img, Preview from @react-email/components
       - Export interface AnniversaryReminderEmailProps: { recipientName: string, occasionType: string, createSongUrl: string, unsubscribeUrl: string, unsubscribeAllUrl: string }
       - Export function AnniversaryReminderEmail(props) that returns a full React Email template:
         - Preview text: "It's almost time to celebrate {occasionType} again!"
         - Body: white background (#ffffff), sans-serif font family
         - Container: max-width 600px, centered, 20px padding
         - Header section: "Continue the Story" heading (24px, bold, color #1a1a2e)
         - Body text: "It's almost time to celebrate {occasionType} again! Last year, you created a special song for {recipientName}." (16px, line-height 24px, color #333)
         - Second paragraph: "Create a new version to continue your musical tradition:"
         - CTA Button: "Create This Year's Song" linking to createSongUrl, styled with backgroundColor '#7c3aed' (purple, matching app theme), color white, padding '14px 28px', borderRadius '8px', fontSize '16px', fontWeight 'bold', textDecoration 'none'
         - Hr separator (margin 40px 0, borderColor #eee)
         - CAN-SPAM footer section (fontSize 12px, color #999, textAlign center):
           - Company name: "SongSwipe" on its own line
           - Physical address from process.env.COMPANY_ADDRESS || '[Physical Address]'
           - Two unsubscribe links on separate lines:
             a. "Unsubscribe from {occasionType} reminders" linking to unsubscribeUrl
             b. "Unsubscribe from all SongSwipe emails" linking to unsubscribeAllUrl
           - Both links styled: color #999, textDecoration underline
       - Export default AnniversaryReminderEmail (for React Email preview compatibility)
  </action>
  <verify>
    - File exists: src/lib/emails/anniversary-reminder.tsx
    - `npx tsc --noEmit` passes
    - Template exports AnniversaryReminderEmail function
    - Template includes unsubscribe links and physical address placeholder
  </verify>
  <done>
    React Email template renders anniversary reminder with "Continue the Story" heading, personalized body text, purple CTA button, and CAN-SPAM compliant footer with per-occasion and global unsubscribe links.
  </done>
</task>

<task type="auto">
  <name>Task 2: Inngest cron + email sender functions and route registration</name>
  <files>
    src/lib/inngest/functions/check-anniversaries.ts
    src/lib/inngest/functions/send-reminder-email.ts
    src/app/api/inngest/route.ts
  </files>
  <action>
    1. Create `src/lib/inngest/functions/check-anniversaries.ts`:
       - Import inngest from '@/lib/inngest/client', createServerSupabaseClient from '@/lib/supabase'
       - Import addDays, format, getMonth, getDate from 'date-fns'
       - Export const checkAnniversaries = inngest.createFunction() with:
         - Config: { id: 'check-anniversaries', name: 'Check Upcoming Anniversaries' }
         - Trigger: { cron: '0 9 * * *' } (daily at 9am UTC -- better open rates than midnight)
         - Handler async ({ step }):
           a. step.run('query-upcoming-occasions'): Query orders table via service role client
              - Select: id, user_id, occasion_date, occasion_type, customization_id, created_at, and join customizations(recipient_name) and also get user email via auth.admin.getUserById
              - Filter: occasion_date IS NOT NULL, status = 'completed' or 'paid'
              - Anniversary logic: For each order with an occasion_date, calculate if the anniversary falls within the next 7 days:
                - Get month and day from occasion_date
                - Get today's date and the date 7 days from now
                - Check if the anniversary (same month/day this year, or next year if already passed) falls in the 7-day window
              - Engagement filter: Only include orders where the user's last order was within 18 months (query orders table for user's most recent created_at)
              - Return array of OccasionReminder objects
           b. step.run('schedule-reminder-events'): For each reminder, send Inngest event:
              - Event name: 'email/anniversary-reminder.requested'
              - Event data: { orderId, userId, occasionDate, occasionType, recipientName, userEmail }
              - Event ID for deduplication: `anniversary-${orderId}-${format(nextAnniversary, 'yyyy-MM-dd')}` (prevents duplicate reminders if cron runs twice)
              - Calculate sendAt as the anniversary date minus 7 days at 9am UTC (the reminder send time)
              - Include sendAt in event data
           c. Return { remindersScheduled: reminders.length }

       IMPORTANT: The anniversary query logic should be:
       - Extract month and day from occasion_date
       - Calculate the NEXT occurrence of that month/day (could be this year or next year)
       - Check if (nextOccurrence - 7 days) falls on today (or within a small window to account for cron timing)
       - This approach avoids sending reminders every day for 7 days straight

    2. Create `src/lib/inngest/functions/send-reminder-email.ts`:
       - Import inngest from '@/lib/inngest/client', createServerSupabaseClient from '@/lib/supabase'
       - Import Resend from 'resend'
       - Import AnniversaryReminderEmail from '@/lib/emails/anniversary-reminder'
       - Export const sendReminderEmail = inngest.createFunction() with:
         - Config: { id: 'send-reminder-email', name: 'Send Anniversary Reminder Email', retries: 3 }
         - Trigger: { event: 'email/anniversary-reminder.requested' }
         - Handler async ({ event, step }):
           a. step.sleepUntil('wait-for-send-date', event.data.sendAt) -- sleep until 7 days before anniversary
           b. step.run('check-preferences'): Query email_preferences for user_id
              - If global_unsubscribe is true, return { skipped: true, reason: 'global_unsubscribe' }
              - If occasion_unsubscribes array includes event.data.orderId, return { skipped: true, reason: 'occasion_unsubscribe' }
              - Return preferences data
           c. If step b returned skipped, return early with skip reason
           d. step.run('fetch-user-email'): Get user email via supabase.auth.admin.getUserById(event.data.userId)
              - If no user found, return { skipped: true, reason: 'user_not_found' }
           e. step.run('send-email'): Use Resend to send email
              - const resend = new Resend(process.env.RESEND_API_KEY)
              - Get unsubscribe token from email_preferences for this user
              - Build URLs:
                - createSongUrl: `${process.env.NEXT_PUBLIC_APP_URL || 'https://songswipe.app'}/customize?occasion=${encodeURIComponent(event.data.occasionType)}`
                - unsubscribeUrl: `${process.env.NEXT_PUBLIC_APP_URL || 'https://songswipe.app'}/api/unsubscribe/${token}?order_id=${event.data.orderId}`
                - unsubscribeAllUrl: `${process.env.NEXT_PUBLIC_APP_URL || 'https://songswipe.app'}/api/unsubscribe/${token}`
              - Send via resend.emails.send():
                - from: 'SongSwipe <reminders@songswipe.app>' (or process.env.RESEND_FROM_EMAIL)
                - to: user email
                - subject: `Continue the story for ${formatOccasion(event.data.occasionType)}`
                - react: AnniversaryReminderEmail({ recipientName, occasionType: formatOccasion(occasionType), createSongUrl, unsubscribeUrl, unsubscribeAllUrl })
                - headers: { 'List-Unsubscribe': `<${unsubscribeAllUrl}>`, 'List-Unsubscribe-Post': 'List-Unsubscribe=One-Click' }
              - Return { sent: true, to: userEmail }

       Add a helper function formatOccasion(occasion: string): string that capitalizes and removes hyphens (e.g., 'valentines-day' -> "Valentine's Day", 'birthday' -> 'Birthday'). Reuse the pattern from the share page if it exists, otherwise create inline.

    3. Update `src/app/api/inngest/route.ts`:
       - Add imports for checkAnniversaries and sendReminderEmail from their new paths
       - Add both functions to the functions array: [generateSongFunction, checkAnniversaries, sendReminderEmail]
  </action>
  <verify>
    - Files exist: check-anniversaries.ts, send-reminder-email.ts
    - `npx tsc --noEmit` passes
    - Inngest route.ts imports and registers both new functions
    - check-anniversaries uses cron trigger
    - send-reminder-email checks preferences AFTER sleepUntil (not before)
    - Event ID includes orderId + anniversary date for deduplication
  </verify>
  <done>
    Daily cron queries upcoming anniversaries with engagement filter (18 months), schedules individual reminder events with deduplication IDs. Send function sleeps until send date, checks opt-out preferences at send time, sends CAN-SPAM compliant email via Resend with "Continue the Story" CTA. Both functions registered in Inngest route.
  </done>
</task>

</tasks>

<verification>
- `npm run build` or `npx tsc --noEmit` passes
- src/lib/inngest/functions/check-anniversaries.ts exports checkAnniversaries with cron trigger
- src/lib/inngest/functions/send-reminder-email.ts exports sendReminderEmail with event trigger
- src/lib/emails/anniversary-reminder.tsx exports AnniversaryReminderEmail with CAN-SPAM footer
- src/app/api/inngest/route.ts registers all 3 functions (generate-song + 2 new)
- Preference check happens inside send-reminder-email AFTER sleepUntil
- Event deduplication uses orderId + anniversary date in event ID
</verification>

<success_criteria>
- Daily cron function queries upcoming anniversaries and schedules individual reminder events
- Email sender function sleeps until 7 days before anniversary, checks opt-out at send time, sends via Resend
- React Email template includes personalized content, purple CTA button, and CAN-SPAM compliant footer
- List-Unsubscribe and List-Unsubscribe-Post headers included for one-click unsubscribe
- Engagement filter prevents reminders to users inactive for 18+ months
- Inngest event ID deduplication prevents duplicate reminders
</success_criteria>

<output>
After completion, create `.planning/phases/09-retention-marketing/09-02-SUMMARY.md`
</output>
