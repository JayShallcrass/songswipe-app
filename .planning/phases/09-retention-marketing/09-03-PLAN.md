---
phase: 09-retention-marketing
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/app/api/unsubscribe/[token]/route.ts
autonomous: true

must_haves:
  truths:
    - "User can unsubscribe from a specific occasion's reminders via URL without login"
    - "User can unsubscribe from all SongSwipe emails via URL without login"
    - "Invalid or expired tokens return a friendly error page, not a crash"
    - "Unsubscribe action returns a styled HTML confirmation page"
    - "POST handler supports RFC 8058 one-click unsubscribe from email clients"
  artifacts:
    - path: "src/app/api/unsubscribe/[token]/route.ts"
      provides: "GET and POST handlers for unsubscribe actions"
      exports: ["GET", "POST"]
  key_links:
    - from: "src/app/api/unsubscribe/[token]/route.ts"
      to: "email_preferences table"
      via: "Supabase query by unsubscribe_token, then update"
      pattern: "email_preferences.*unsubscribe_token"
---

<objective>
Build the unsubscribe API route that handles both web-based (GET) and one-click (POST) unsubscribe requests, enabling CAN-SPAM compliant opt-out without requiring user login.

Purpose: Satisfies RETAIN-04 (user can opt out per occasion or globally). This route is referenced in every anniversary reminder email's unsubscribe links and List-Unsubscribe headers.
Output: API route handler with GET (web unsubscribe + confirmation page) and POST (RFC 8058 one-click).
</objective>

<execution_context>
@/Users/jamesshallcrass/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamesshallcrass/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-retention-marketing/09-RESEARCH.md
@src/lib/supabase.ts
@src/types/database.ts
@src/types/email-preferences.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unsubscribe API route with GET and POST handlers</name>
  <files>
    src/app/api/unsubscribe/[token]/route.ts
  </files>
  <action>
    Create `src/app/api/unsubscribe/[token]/route.ts` with two handlers:

    **GET handler** (web-based unsubscribe from email link clicks):
    1. Extract token from params (Next.js 15 dynamic route pattern: { params }: { params: Promise<{ token: string }> }, await params)
    2. Extract optional query params from URL: order_id (for per-occasion unsubscribe), all (for global unsubscribe)
    3. Use createServerSupabaseClient() (service role -- no auth required for unsubscribe)
    4. Query email_preferences where unsubscribe_token = token
    5. If no record found, return HTML error page (styled, user-friendly):
       - "This unsubscribe link is invalid or has expired."
       - Return with status 404, Content-Type text/html
    6. If order_id query param present (per-occasion unsubscribe):
       - Read current occasion_unsubscribes array
       - If order_id already in array, skip update (idempotent)
       - Otherwise, append order_id to occasion_unsubscribes array
       - Update the record via supabase.from('email_preferences').update()
       - Return HTML success page: "You've been unsubscribed from reminders for this occasion."
    7. If no order_id (or 'all' query param present) -- global unsubscribe:
       - Set global_unsubscribe = true
       - Update the record
       - Return HTML success page: "You've been unsubscribed from all SongSwipe reminder emails."
    8. Update updated_at to NOW() on every update

    **POST handler** (RFC 8058 one-click unsubscribe from email client buttons):
    1. Extract token from params (same pattern as GET)
    2. Query email_preferences where unsubscribe_token = token
    3. If no record found, return 404 JSON: { error: 'Invalid token' }
    4. Set global_unsubscribe = true (one-click always does global per RFC 8058)
    5. Update the record, set updated_at to NOW()
    6. Return 200 JSON: { success: true }

    **HTML response helper** -- create a helper function generateHtmlPage(title: string, message: string, isError: boolean): string that returns a minimal styled HTML page:
    - DOCTYPE html, charset utf-8, viewport meta
    - Inline CSS (no external deps): body { font-family: system-ui, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background: #f9fafb; }
    - Container div: max-width 480px, padding 40px, background white, border-radius 12px, box-shadow, text-align center
    - Icon: checkmark (green) for success, X (red) for error (use HTML entities or simple SVG)
    - Title in h1 (20px)
    - Message in p (16px, color #666)
    - "Return to SongSwipe" link pointing to process.env.NEXT_PUBLIC_APP_URL || 'https://songswipe.app'
    - SongSwipe branding: purple accent color (#7c3aed) on the link

    Return HTML responses with headers: Content-Type: text/html, charset: utf-8
  </action>
  <verify>
    - File exists: src/app/api/unsubscribe/[token]/route.ts
    - `npx tsc --noEmit` passes
    - File exports GET and POST functions
    - GET handler checks for order_id param (per-occasion) vs global
    - POST handler always does global unsubscribe
    - Invalid token returns 404 with friendly error page
    - HTML responses are self-contained (no external CSS/JS dependencies)
  </verify>
  <done>
    Unsubscribe route handles per-occasion opt-out (GET with order_id param), global opt-out (GET without order_id), and RFC 8058 one-click (POST). Invalid tokens return styled 404 page. Success shows confirmation with "Return to SongSwipe" link. No login required for any unsubscribe action.
  </done>
</task>

</tasks>

<verification>
- `npm run build` or `npx tsc --noEmit` passes
- src/app/api/unsubscribe/[token]/route.ts exports both GET and POST
- GET with order_id param updates occasion_unsubscribes array
- GET without order_id updates global_unsubscribe to true
- POST always sets global_unsubscribe to true (RFC 8058)
- Invalid tokens return 404 with styled HTML error page
- Success returns styled HTML confirmation page
- No authentication required for unsubscribe actions
</verification>

<success_criteria>
- Per-occasion unsubscribe works via GET with order_id query parameter
- Global unsubscribe works via GET without order_id
- One-click unsubscribe works via POST (RFC 8058 for email client buttons)
- Invalid/expired tokens show friendly error page (not JSON error or crash)
- Success pages are self-contained HTML with SongSwipe branding
- All unsubscribe operations are idempotent (re-clicking link has no side effects)
</success_criteria>

<output>
After completion, create `.planning/phases/09-retention-marketing/09-03-SUMMARY.md`
</output>
