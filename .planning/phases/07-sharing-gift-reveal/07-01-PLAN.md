---
phase: 07-sharing-gift-reveal
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/share/[token]/page.tsx
  - src/app/share/[token]/loading.tsx
  - src/app/share/[token]/opengraph-image.tsx
  - src/lib/share/generateShareUrl.ts
autonomous: true

must_haves:
  truths:
    - "Share page at /share/[token] loads song data without requiring login"
    - "Share page displays recipient name, occasion, and sender message"
    - "Invalid or non-existent tokens show a proper 404 page"
    - "Sharing a link on social media shows a personalized OG image with recipient name and occasion"
    - "Only selected variants with completed generation are accessible via share token"
  artifacts:
    - path: "src/app/share/[token]/page.tsx"
      provides: "Public share page server component with data fetching and metadata"
      exports: ["default", "generateMetadata"]
    - path: "src/app/share/[token]/loading.tsx"
      provides: "Loading skeleton for share page"
      exports: ["default"]
    - path: "src/app/share/[token]/opengraph-image.tsx"
      provides: "Dynamic OG image generator (1200x630 PNG)"
      exports: ["default", "alt", "size", "contentType"]
    - path: "src/lib/share/generateShareUrl.ts"
      provides: "Helper to build full share URL from token"
      exports: ["generateShareUrl"]
  key_links:
    - from: "src/app/share/[token]/page.tsx"
      to: "song_variants table"
      via: "service role Supabase client query filtered by share_token + selected + complete"
      pattern: "createServerSupabaseClient.*share_token.*selected.*generation_status"
    - from: "src/app/share/[token]/opengraph-image.tsx"
      to: "song_variants table"
      via: "service role Supabase client query for OG image data"
      pattern: "createServerSupabaseClient.*share_token"
---

<objective>
Create the public share page route (/share/[token]) as a Next.js server component that fetches song data via service role key, generates dynamic metadata for SEO, and produces personalized OG images for social media previews.

Purpose: This is the foundation of the sharing experience. The server component securely fetches song data without exposing credentials, validates share tokens, and provides all necessary data to client components (built in Plan 02). The OG image ensures links shared on WhatsApp, Facebook, and Twitter show a branded preview with the recipient's name and occasion.

Output: Public share page route, dynamic OG image generator, share URL helper utility, loading skeleton.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-sharing-gift-reveal/07-RESEARCH.md
@.planning/phases/05-song-delivery/05-01-SUMMARY.md
@src/lib/supabase.ts
@src/types/database.ts
@src/app/layout.tsx
@src/app/song/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create share page server component with data fetching and metadata</name>
  <files>
    src/app/share/[token]/page.tsx
    src/app/share/[token]/loading.tsx
    src/lib/share/generateShareUrl.ts
  </files>
  <action>
Create the share URL helper first:
- `src/lib/share/generateShareUrl.ts`: Export function `generateShareUrl(token: string): string` that returns `${process.env.NEXT_PUBLIC_APP_URL}/share/${token}`. This is used by both the share page and the song delivery page.

Create the loading skeleton:
- `src/app/share/[token]/loading.tsx`: Default export a loading component with dark gradient background (matching app theme: `bg-gradient-to-b from-gray-900 via-purple-900/20 to-gray-900`), centered spinner, and "Loading your gift..." text. Keep it simple -- a pulsing animation similar to existing loading patterns in the codebase.

Create the share page server component:
- `src/app/share/[token]/page.tsx`: This is a Next.js server component (no 'use client' directive).

**Data fetching:**
- Use `createServerSupabaseClient()` from `@/lib/supabase` (service role key, bypasses RLS).
- Accept `params: Promise<{ token: string }>` (Next.js 14 dynamic route params pattern).
- Await params to get token.
- Validate UUID format with regex: `/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i` -- call `notFound()` from `next/navigation` if invalid.
- Query `song_variants` table:
  ```
  .select(`
    id,
    storage_path,
    duration_ms,
    share_token,
    orders(
      id,
      occasion_date,
      created_at,
      customizations(
        recipient_name,
        your_name,
        occasion,
        genre,
        mood
      )
    )
  `)
  .eq('share_token', token)
  .eq('selected', true)
  .eq('generation_status', 'complete')
  .single()
  ```
- If error or no data, call `notFound()`.
- Unwrap nested response same as existing pattern (see `/api/songs/[id]/route.ts`): handle both array and object forms of orders/customizations.

**Page rendering:**
- Export default async function `SharePage`.
- Build shareUrl using `generateShareUrl(token)`.
- Derive a personal message: `"${customization.your_name} created this special ${customization.occasion} song just for you!"`.
- Render a wrapper `<main>` with dark gradient background.
- For now, render a placeholder structure that passes data to client components (GiftReveal, ShareButtons -- these are created in Plan 02). Use simple HTML placeholders where client components will go:
  - A centered section with: recipient name heading, personal message, a div with `id="gift-reveal-slot"` comment placeholder noting GiftReveal component goes here (Plan 02), and a div with `id="share-buttons-slot"` comment placeholder for ShareButtons (Plan 02).
  - Pass variant ID and storage path as data attributes or in a script tag for client hydration -- actually, better approach: render a client component wrapper `SharePageClient` that receives all the serializable data as props. Export a separate `SharePageClient` from a client component file OR simply render the data in server component JSX for now and replace with client components in Plan 02.
  - **Simplest approach**: Render everything in server component for now. Show recipient name, personal message, occasion info. Plan 02 will refactor to add GiftReveal client component. This avoids creating throwaway code.

**Metadata:**
- Export `generateMetadata` async function.
- Same data fetching pattern (query by share_token, single).
- If no data found, return generic metadata: `{ title: 'Personalized Song Gift | SongSwipe', description: 'A special personalized song created with SongSwipe' }`.
- If data found, return:
  ```typescript
  {
    title: `${occasion} Song for ${recipientName} | SongSwipe`,
    description: `${senderName} created a personalized ${occasion} song for ${recipientName}. Listen now!`,
    openGraph: {
      title: `${occasion} Song for ${recipientName}`,
      description: `From ${senderName} with love`,
      type: 'music.song',
    },
    twitter: {
      card: 'summary_large_image',
    },
  }
  ```

**Important:** Do NOT use `supabase.auth.getUser()` -- this is a public page with no authentication. Use the service role client directly to query by share_token.
  </action>
  <verify>
Run `npx tsc --noEmit` from project root. Verify:
- No TypeScript errors.
- `src/app/share/[token]/page.tsx` exists with `generateMetadata` and default export.
- `src/app/share/[token]/loading.tsx` exists with default export.
- `src/lib/share/generateShareUrl.ts` exists with named export.
  </verify>
  <done>
Share page server component renders song data for a valid share_token without requiring authentication. Invalid tokens trigger Next.js 404. Dynamic metadata provides personalized title and description for SEO and social sharing. Loading skeleton displays during server-side data fetch.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create dynamic OG image generator</name>
  <files>
    src/app/share/[token]/opengraph-image.tsx
  </files>
  <action>
Create the OG image generator using Next.js opengraph-image file convention:

- `src/app/share/[token]/opengraph-image.tsx`: This file is automatically used by Next.js to generate OG images for the /share/[token] route.

**Exports:**
- `export const alt = 'Personalized song gift from SongSwipe'`
- `export const size = { width: 1200, height: 630 }`
- `export const contentType = 'image/png'`

**Default export (async function Image):**
- Accept `{ params }: { params: Promise<{ token: string }> }`.
- Await params, extract token.
- Use `createServerSupabaseClient()` to query song_variants by share_token (same query pattern as page.tsx but only select customization fields needed for the image).
- Import `ImageResponse` from `next/og`.

**If no data found (fallback image):**
- Return `new ImageResponse(...)` with:
  - Full-width/height div with `background: '#1F1128'` (dark purple, matches app theme).
  - Centered layout using flexbox (`display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center'`).
  - Music note emoji (fontSize 96).
  - "A personalized song gift" text (fontSize 48, white).
  - "SongSwipe" branding at bottom (fontSize 36, opacity 0.8).

**If data found (personalized image):**
- Return `new ImageResponse(...)` with:
  - Full-width/height div with `background: 'linear-gradient(135deg, #1F1128 0%, #4C1D95 50%, #BE185D 100%)'` (dark purple to pink gradient, matching app theme -- NOT the bright pink from research, use the darker purple-to-pink that matches the existing gradient).
  - Gift emoji (fontSize 80) at top.
  - "For {recipientName}" in large bold text (fontSize 64, white).
  - "{occasion} Song" below (fontSize 40, white with 0.9 opacity).
  - "From {senderName}" below that (fontSize 36, white with 0.8 opacity).
  - "SongSwipe" branding positioned at bottom (absolute position, bottom 40px, fontSize 32, white with 0.7 opacity).
  - All text uses system default fonts (no custom font loading needed for v1).
  - All style properties as inline objects (ImageResponse uses Satori which supports a subset of CSS as JS objects).

**Important notes:**
- ImageResponse JSX supports only a subset of CSS. Use `display: 'flex'` on all containers. No Tailwind classes -- inline styles only.
- Use `tw` prop if satori supports it, but safer to use `style` objects.
- Ensure all divs that contain children have `display: 'flex'`.
- Format occasion nicely: capitalize first letter, replace hyphens with spaces (e.g., "just-because" -> "Just Because"). Create a simple inline helper.
  </action>
  <verify>
Run `npx tsc --noEmit` from project root. Verify:
- No TypeScript errors.
- `src/app/share/[token]/opengraph-image.tsx` exists.
- File exports `alt`, `size`, `contentType`, and default function.
- `ImageResponse` is imported from `next/og`.
  </verify>
  <done>
Dynamic OG image generates a 1200x630 PNG per share token. Personalized images show recipient name, occasion, sender name, and SongSwipe branding on a purple-to-pink gradient. Missing tokens produce a generic branded fallback image. Social media platforms (WhatsApp, Facebook, Twitter/X) will display these images when the share link is posted.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. Share page route exists at `src/app/share/[token]/page.tsx` with server-side data fetching
3. `generateMetadata` returns personalized title/description when share token is valid
4. OG image file at `src/app/share/[token]/opengraph-image.tsx` exports correct constants and default function
5. Loading skeleton exists at `src/app/share/[token]/loading.tsx`
6. Share URL helper exists at `src/lib/share/generateShareUrl.ts`
7. No authentication is required on the share page
8. Invalid UUID tokens trigger 404 via `notFound()`
</verification>

<success_criteria>
- Share page loads song data using service role key without authentication
- Invalid/missing share tokens show 404
- Dynamic metadata provides personalized SEO data per song
- OG image generates branded 1200x630 PNG per share token
- Only selected + complete variants are accessible
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-sharing-gift-reveal/07-01-SUMMARY.md`
</output>
