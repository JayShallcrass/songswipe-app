---
phase: 03-swipe-builder
plan: 03
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - src/components/forms/PersonalizationForm.tsx
  - src/app/customize/page.tsx
autonomous: true

must_haves:
  truths:
    - "User fills a text form with recipient name, sender name, memories, and special details after completing all 4 swipe stages"
    - "Form validates required fields (recipient name, sender name) and shows inline error messages"
    - "Completed swipe selections and text input are submitted together as a song creation request to /api/customize"
    - "After successful submission, user is redirected to Stripe checkout for payment"
    - "The /customize page shows swipe stages first, then transitions to the personalization form when swipe is complete"
    - "User can start over (reset all swipe selections and form data) at any point"
  artifacts:
    - path: "src/components/forms/PersonalizationForm.tsx"
      provides: "Text input form for recipient name, sender name, memories, and things to avoid"
      exports: ["PersonalizationForm"]
    - path: "src/app/customize/page.tsx"
      provides: "Rewritten customize page orchestrating swipe flow and personalization form"
      exports: ["default"]
  key_links:
    - from: "src/app/customize/page.tsx"
      to: "src/lib/swipe-state.ts"
      via: "uses useSwipeState hook for managing swipe flow"
      pattern: "useSwipeState"
    - from: "src/app/customize/page.tsx"
      to: "src/components/swipe/SwipeStack.tsx"
      via: "renders SwipeStack for card swiping stages"
      pattern: "SwipeStack"
    - from: "src/app/customize/page.tsx"
      to: "src/components/forms/PersonalizationForm.tsx"
      via: "renders PersonalizationForm when swipe stages complete"
      pattern: "PersonalizationForm"
    - from: "src/app/customize/page.tsx"
      to: "/api/customize"
      via: "POST fetch submitting combined swipe selections and form data"
      pattern: "fetch.*api/customize"
    - from: "src/components/forms/PersonalizationForm.tsx"
      to: "src/lib/elevenlabs.ts"
      via: "uses Customization type for form data shape"
      pattern: "Customization"
---

<objective>
Build the personalization form and rewrite the /customize page to orchestrate the complete swipe-to-form-to-checkout flow.

Purpose: This is the final assembly plan that brings together the swipe engine (Plan 03-01), swipe UI components (Plan 03-02), and the personalization text form into a cohesive page experience. The /customize page is the core product experience users interact with, replacing the old 3-step form wizard with the swipe builder followed by text personalization.

Output: PersonalizationForm component and fully rewritten /customize page.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-swipe-builder/03-RESEARCH.md

# Dependencies from Plans 01 and 02
@.planning/phases/03-swipe-builder/03-01-SUMMARY.md
@.planning/phases/03-swipe-builder/03-02-SUMMARY.md

# Existing page being replaced (preserve submission logic pattern)
@src/app/customize/page.tsx
@src/lib/elevenlabs.ts
@src/lib/supabase.ts
@src/app/api/customize/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build PersonalizationForm component</name>
  <files>
    src/components/forms/PersonalizationForm.tsx
  </files>
  <action>
**src/components/forms/PersonalizationForm.tsx** -- Text form for after swipe completion:

1. Add `'use client'` directive
2. Import `useState` from 'react'
3. Import `motion` from 'framer-motion'

4. Define `PersonalizationData` interface (exported):
   - `recipientName: string`
   - `yourName: string`
   - `specialMemories: string`
   - `thingsToAvoid: string`

5. Define `PersonalizationFormProps`:
   - `onSubmit: (data: PersonalizationData) => void`
   - `onBack: () => void` (go back to swipe stages)
   - `isLoading: boolean` (disable form during submission)
   - `selections: Record<string, string>` (swipe selections to show in summary)

6. Component logic:
   - Local state for each form field (recipientName, yourName, specialMemories, thingsToAvoid) using useState('')
   - Local state for errors: `Record<string, string>`
   - `validate()` function:
     - recipientName is required (non-empty after trim)
     - yourName is required (non-empty after trim)
     - specialMemories and thingsToAvoid are optional
     - Returns boolean, sets errors state
   - `handleSubmit()`: validate, if valid call `onSubmit` with form data

7. Render (use motion.div for entrance animation: `initial={{ opacity: 0, y: 20 }}, animate={{ opacity: 1, y: 0 }}`):
   - White card container (bg-white rounded-2xl shadow-sm p-8, matching existing customize page style)
   - Heading: "Tell us about them" (text-3xl font-bold)
   - Subtitle: "Add personal details to make your song special"

   - Song summary section at top showing swipe selections:
     - Purple-tinted summary card (bg-purple-50 rounded-xl p-4)
     - Shows: Occasion, Mood, Genre, Voice selections from props
     - Uses proper display labels (capitalize, handle hyphenated values like 'just-because' -> 'Just Because')

   - Form fields:
     - Recipient's Name (required): text input, same styling as existing customize page
     - Your Name (required): text input
     - Special Memories (optional): textarea with min-h-[120px], placeholder "Share special memories, inside jokes, or details you'd like woven into the lyrics..."
     - Things to Avoid (optional): text input, placeholder "Anything you'd like us to avoid mentioning?"
   - Each field has error display: red text below input if validation fails
   - All inputs styled consistently with existing page: `w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500`

   - Action buttons at bottom:
     - "Back to Selections" button (text style, flex-1)
     - "Continue to Payment" button (gradient purple-to-pink, flex-1, disabled state when isLoading)
     - Show loading spinner/text when isLoading: "Processing..."

Follow existing conventions: single quotes, 2-space indent, 'use client', gradient theme, Tailwind utility classes.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | head -30` for TypeScript check. Verify `src/components/forms/PersonalizationForm.tsx` exports PersonalizationForm and PersonalizationData. Verify it contains required field validation for recipientName and yourName.
  </verify>
  <done>
PersonalizationForm collects recipient name, sender name, memories, and things to avoid with inline validation. Shows swipe selection summary. Matches existing page styling. Supports loading state for submission.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite /customize page with swipe-to-form flow</name>
  <files>
    src/app/customize/page.tsx
  </files>
  <action>
**src/app/customize/page.tsx** -- Complete rewrite of the customize page:

1. Keep `'use client'` directive
2. Import dependencies:
   - `useRouter` from 'next/navigation'
   - `useState`, `useEffect`, `useCallback` from 'react'
   - `createBrowserClient` from '@supabase/ssr'
   - `useSwipeState` from `@/lib/swipe-state`
   - `useSwipeKeyboard` from `@/lib/swipe-keyboard`
   - `SwipeStack` from `@/components/swipe/SwipeStack`
   - `SwipeProgress` from `@/components/swipe/SwipeProgress`
   - `PersonalizationForm` and `PersonalizationData` from `@/components/forms/PersonalizationForm`
   - `STAGE_CONFIG` from `@/lib/swipe-data`
   - `AnimatePresence` from 'framer-motion'
   - `Link` from 'next/link'

3. Component state:
   - `supabase` client (initialized on mount, same pattern as existing page)
   - `isLoading: boolean` for form submission
   - `showHints: boolean` (true initially, set false on dismiss)
   - Get all swipe state from `useSwipeState()`: state, handleSwipe, undo, reset, canUndo, isSwipeComplete, progress, currentStageConfig

4. Set up keyboard navigation:
   - Call `useSwipeKeyboard` with:
     - `onSwipeLeft`: callback that triggers left swipe on current card (calls `handleSwipe(currentCard.id, 'left')`)
     - `onSwipeRight`: callback that triggers right swipe on current card (calls `handleSwipe(currentCard.id, 'right')`)
     - `onUndo`: undo function from useSwipeState
     - `canUndo`: from useSwipeState
     - `disabled`: true when `isSwipeComplete` (user is on the personalization form -- keyboard should not interfere with text inputs)

5. `handleFormSubmit(data: PersonalizationData)` async function:
   - Set isLoading true
   - Get authenticated user from supabase (redirect to /auth/login?redirect=/customize if not logged in)
   - Build the request body combining swipe selections + form data:
     ```typescript
     const body = {
       recipientName: data.recipientName,
       yourName: data.yourName,
       occasion: state.selections.occasion,
       songLength: '90', // Default to 90s (song length selection was removed from swipe flow per research -- can be added back)
       mood: [state.selections.mood], // Wrap single mood selection in array to match existing schema
       genre: state.selections.genre,
       specialMemories: data.specialMemories || undefined,
       thingsToAvoid: data.thingsToAvoid || undefined,
     }
     ```
   - POST to `/api/customize` (same endpoint as before)
   - On success: redirect to `checkoutUrl` (window.location.href)
   - On error: alert('Something went wrong. Please try again.'), set isLoading false
   - Note: voice style selection (`state.selections.voice`) is stored but not sent to current /api/customize endpoint. It will be used in Phase 4 when Eleven Labs integration is enhanced. This is intentional -- do NOT modify the API endpoint.

6. `handleBack()` for PersonalizationForm:
   - Call undo() to go back to last swipe stage (voice style)
   - This way the user can re-swipe the last stage if they want

7. `handleStartOver()`:
   - Call reset() to clear all swipe state and sessionStorage
   - Clear showHints if they were dismissed

8. Render layout:
   - Outer container: `min-h-screen bg-gray-50`
   - Header section (matches existing customize page style):
     - SongSwipe logo/link on left (Link to "/")
     - "My Songs" link and "Sign Out" button on right
     - SwipeProgress component below header (replaces old progress bar)
   - Main content area: `max-w-2xl mx-auto px-6 py-8`
   - Use `AnimatePresence mode="wait"` to transition between swipe and form views:
     - **If NOT isSwipeComplete**: Show swipe interface
       - Get `currentStageConfig` from useSwipeState
       - Render SwipeStack with:
         - cards from currentStageConfig.cards
         - currentCardIndex from state
         - stage, stageTitle, stageSubtitle from currentStageConfig
         - onSwipe, onUndo, canUndo passed through
         - showHints and onHintsDismiss
       - "Start Over" link at bottom (calls handleStartOver)
     - **If isSwipeComplete**: Show personalization form
       - Render PersonalizationForm with:
         - onSubmit: handleFormSubmit
         - onBack: handleBack
         - isLoading
         - selections: state.selections (for summary display)
       - "Start Over" link at bottom

   - Use motion.div wrappers with keys for AnimatePresence transitions between swipe and form views

Delete ALL old 3-step form wizard code (steps 1-3, occasions/moods/genres arrays, validateStep, handleNext, handleBack for steps). The new page completely replaces the old approach. The occasion, mood, and genre data now lives in `src/lib/swipe-data.ts`.

Preserve: Supabase client initialization pattern, auth check pattern, /api/customize submission pattern, error handling pattern.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | head -30` for TypeScript check. Verify `src/app/customize/page.tsx` imports and renders SwipeStack, SwipeProgress, PersonalizationForm. Verify it calls useSwipeState and useSwipeKeyboard. Verify it POSTs to /api/customize with combined swipe selections + form data. Verify old step-based wizard code is removed.
  </verify>
  <done>
/customize page orchestrates the full flow: swipe through 4 stages (occasion, mood, genre, voice), then fill personalization form, then submit to /api/customize and redirect to Stripe checkout. Keyboard navigation active during swipe stages, disabled during form. Start Over and undo available throughout. Old 3-step wizard completely replaced.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles without errors
2. `/customize` page imports and renders SwipeStack for swipe stages
3. `/customize` page imports and renders PersonalizationForm after swipe completion
4. PersonalizationForm validates recipientName and yourName as required
5. PersonalizationForm shows swipe selection summary (occasion, mood, genre, voice)
6. Combined swipe + form data POSTs to /api/customize matching existing schema (recipientName, yourName, occasion, mood, genre, songLength, specialMemories, thingsToAvoid)
7. Successful submission redirects to Stripe checkout URL
8. useSwipeKeyboard disabled when PersonalizationForm is active
9. "Start Over" button resets all state and sessionStorage
10. Old 3-step wizard code fully removed from customize page
</verification>

<success_criteria>
- User flows through 4 swipe stages then fills text form and submits to checkout
- Personalization form validates required fields and shows helpful error messages
- Swipe selections combined with form data match existing /api/customize schema
- Voice style stored for future Phase 4 use but not sent to current API
- Page transitions smoothly between swipe and form views
- Start Over and undo work correctly at any point
- Old wizard code completely replaced
- All files pass TypeScript compilation
</success_criteria>

<output>
After completion, create `.planning/phases/03-swipe-builder/03-03-SUMMARY.md`
</output>
