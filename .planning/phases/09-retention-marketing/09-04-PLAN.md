---
phase: 09-retention-marketing
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/005_add_customization_occasion_date.sql
  - src/types/database.ts
  - src/components/forms/PersonalizationForm.tsx
  - src/app/api/customize/route.ts
  - src/app/customize/page.tsx
  - src/app/api/webhook/route.ts
  - src/actions/checkout.ts
  - src/lib/inngest/functions/check-anniversaries.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Occasion date is captured from the user during song personalization"
    - "Occasion date is stored on the order record when created via Stripe webhook"
    - "Occasion date is stored on the order record when created via bundle credit redemption"
    - "Anniversary checker queries the correct occasion field from customizations join"
  artifacts:
    - path: "supabase/migrations/005_add_customization_occasion_date.sql"
      provides: "occasion_date column on customizations table"
      contains: "ALTER TABLE customizations ADD COLUMN"
    - path: "src/components/forms/PersonalizationForm.tsx"
      provides: "Optional date picker for occasion date"
      contains: "occasionDate"
    - path: "src/app/api/webhook/route.ts"
      provides: "occasion_date populated on order insert"
      contains: "occasion_date"
    - path: "src/lib/inngest/functions/check-anniversaries.ts"
      provides: "Correct query joining customizations for occasion field"
      contains: "customizations(recipient_name, occasion)"
  key_links:
    - from: "src/components/forms/PersonalizationForm.tsx"
      to: "src/app/customize/page.tsx"
      via: "occasionDate in PersonalizationData interface"
      pattern: "occasionDate"
    - from: "src/app/customize/page.tsx"
      to: "/api/customize"
      via: "fetch POST body includes occasionDate"
      pattern: "occasionDate.*data\\.occasionDate"
    - from: "src/app/api/customize/route.ts"
      to: "customizations table"
      via: "insert includes occasion_date"
      pattern: "occasion_date.*customization\\.occasionDate"
    - from: "src/app/api/webhook/route.ts"
      to: "orders table"
      via: "queries customization for occasion_date, includes in order insert"
      pattern: "occasion_date"
    - from: "src/lib/inngest/functions/check-anniversaries.ts"
      to: "customizations table"
      via: "join selects occasion field"
      pattern: "customizations\\(recipient_name, occasion\\)"
---

<objective>
Close two critical verification gaps that prevent the retention system from functioning:

1. **RETAIN-01 (occasion_date never captured):** Add an optional occasion date picker to the PersonalizationForm, store it on customizations, and wire it through to the order record on creation (both Stripe webhook and bundle credit paths).

2. **RETAIN-02 (non-existent field queried):** Fix check-anniversaries.ts to query `occasion` from the customizations join instead of the non-existent `occasion_type` column on orders.

Purpose: Without these fixes, occasion_date is always NULL (no reminders ever sent) and the daily cron crashes at runtime querying a non-existent column.
Output: Fully wired occasion date pipeline from user input through to anniversary checking.
</objective>

<execution_context>
@/Users/jamesshallcrass/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamesshallcrass/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-retention-marketing/09-VERIFICATION.md
@.planning/phases/09-retention-marketing/09-01-SUMMARY.md
@.planning/phases/09-retention-marketing/09-02-SUMMARY.md

# Source files being modified
@src/components/forms/PersonalizationForm.tsx
@src/app/api/customize/route.ts
@src/app/customize/page.tsx
@src/app/api/webhook/route.ts
@src/actions/checkout.ts
@src/lib/inngest/functions/check-anniversaries.ts
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add occasion date capture to form, API, and database</name>
  <files>
    supabase/migrations/005_add_customization_occasion_date.sql
    src/types/database.ts
    src/components/forms/PersonalizationForm.tsx
    src/app/api/customize/route.ts
    src/app/customize/page.tsx
  </files>
  <action>
    **Migration (005_add_customization_occasion_date.sql):**
    Create a migration that adds an optional occasion_date column to the customizations table:
    ```sql
    ALTER TABLE customizations ADD COLUMN IF NOT EXISTS occasion_date DATE;
    COMMENT ON COLUMN customizations.occasion_date IS 'Optional date of the occasion for anniversary reminders';
    ```

    **TypeScript types (src/types/database.ts):**
    Add `occasion_date: string | null` to the customizations Row type (after `things_to_avoid`).
    Add `occasion_date?: string | null` to the customizations Insert type.
    Add `occasion_date?: string | null` to the customizations Update type.

    **PersonalizationForm (src/components/forms/PersonalizationForm.tsx):**
    1. Add `occasionDate: string` to the PersonalizationData interface (empty string = not provided).
    2. Add state: `const [occasionDate, setOccasionDate] = useState('')`
    3. Add an optional date input field after the "Things to Avoid" field:
       - Label: "Occasion Date (Optional)"
       - Subtitle text: "We'll send you a reminder next year"
       - HTML input type="date"
       - Same styling as other inputs (w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500)
    4. Include occasionDate in the onSubmit call data object.
    5. No validation needed (it's optional). Empty string means no date.

    **Customize API (src/app/api/customize/route.ts):**
    1. Add `occasionDate: z.string().optional()` to the Zod schema (after thingsToAvoid). This accepts an ISO date string like '2025-02-14' or undefined.
    2. In the customizations insert, add: `occasion_date: customization.occasionDate || null`

    **Customize page (src/app/customize/page.tsx):**
    In the handleFormSubmit function, add `occasionDate` to the request body object:
    ```typescript
    occasionDate: data.occasionDate || undefined,
    ```
    Add this after the `thingsToAvoid` line in the body object (around line 84).
  </action>
  <verify>
    Run `npx tsc --noEmit` from project root. Zero type errors.
    Verify PersonalizationForm.tsx contains an input with type="date".
    Verify customize/route.ts insert includes occasion_date field.
    Verify migration file exists at supabase/migrations/005_add_customization_occasion_date.sql.
  </verify>
  <done>
    PersonalizationForm shows an optional date picker. Customize API accepts and stores occasionDate on the customizations record. Migration file ready for manual execution. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire occasion_date to order creation and fix anniversary query</name>
  <files>
    src/app/api/webhook/route.ts
    src/actions/checkout.ts
    src/lib/inngest/functions/check-anniversaries.ts
  </files>
  <action>
    **Webhook (src/app/api/webhook/route.ts) - Gap 1 fix:**
    After the duplicate webhook check and before the order insert (around line 58-61), add a query to fetch the occasion_date from the customization record:
    ```typescript
    // Fetch occasion_date from customization for retention tracking
    const { data: customizationData } = await supabase
      .from('customizations')
      .select('occasion_date')
      .eq('id', customizationId)
      .single()
    ```
    Then in the order insert object (line 63-71), add:
    ```typescript
    occasion_date: customizationData?.occasion_date || null,
    ```
    Add this after the `parent_order_id` field.

    **Checkout action (src/actions/checkout.ts) - Gap 1 fix (bundle credit path):**
    The bundle credit redemption path (lines 37-49) also creates an order directly without occasion_date.
    Before the order insert (around line 37), add a query to fetch occasion_date:
    ```typescript
    // Fetch occasion_date from customization for retention tracking
    const { data: customizationWithDate } = await supabase
      .from('customizations')
      .select('occasion_date')
      .eq('id', customizationId)
      .single()
    ```
    Then in the order insert (line 38-48), add:
    ```typescript
    occasion_date: customizationWithDate?.occasion_date || null,
    ```
    Add this after the `payment_method` field.

    **Check-anniversaries (src/lib/inngest/functions/check-anniversaries.ts) - Gap 2 fix:**
    1. Line 30: Remove `occasion_type,` from the select query entirely (this column does not exist on orders).
    2. Line 32: Change `customizations(recipient_name)` to `customizations(recipient_name, occasion)` to include the occasion type from the customizations join.
    3. Line 111: Change `order.occasion_type || 'special occasion'` to extract occasion from the customizations join data instead. The customizations data is already being cast to `any` on line 62. After line 65 (where recipientName is extracted), add:
       ```typescript
       const occasionType = Array.isArray(customizations)
         ? customizations[0]?.occasion || 'special occasion'
         : customizations?.occasion || 'special occasion'
       ```
    4. Update line 111 to use `occasionType` variable instead of `order.occasion_type || 'special occasion'`:
       ```typescript
       occasionType: occasionType,
       ```
  </action>
  <verify>
    Run `npx tsc --noEmit` from project root. Zero type errors.
    Verify webhook/route.ts order insert includes `occasion_date: customizationData?.occasion_date`.
    Verify checkout.ts bundle credit order insert includes `occasion_date: customizationWithDate?.occasion_date`.
    Verify check-anniversaries.ts does NOT contain the string 'occasion_type' anywhere (grep check).
    Verify check-anniversaries.ts select query contains 'customizations(recipient_name, occasion)'.
  </verify>
  <done>
    Orders created via both Stripe webhook and bundle credit paths include occasion_date from the linked customization record. Anniversary checker correctly queries occasion from the customizations join instead of the non-existent occasion_type column. TypeScript compiles cleanly with no references to occasion_type.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `grep -r "occasion_type" src/` returns zero results (non-existent field fully removed)
3. `grep "occasion_date" src/app/api/webhook/route.ts` shows occasion_date in order insert
4. `grep "occasion_date" src/actions/checkout.ts` shows occasion_date in bundle credit order insert
5. `grep "customizations(recipient_name, occasion)" src/lib/inngest/functions/check-anniversaries.ts` confirms correct join
6. `grep "occasionDate" src/components/forms/PersonalizationForm.tsx` confirms date picker field exists
7. Migration file exists at supabase/migrations/005_add_customization_occasion_date.sql
</verification>

<success_criteria>
1. PersonalizationForm includes an optional date picker that submits occasionDate
2. Customize API validates and stores occasion_date on the customizations record
3. Webhook extracts occasion_date from customization and writes it to the order
4. Bundle credit checkout path extracts occasion_date from customization and writes it to the order
5. Check-anniversaries queries customizations(recipient_name, occasion) instead of non-existent occasion_type
6. All occasion_type references are eliminated from the codebase
7. TypeScript compiles cleanly
8. Migration file ready for manual execution in Supabase SQL Editor
</success_criteria>

<output>
After completion, create `.planning/phases/09-retention-marketing/09-04-SUMMARY.md`
</output>
