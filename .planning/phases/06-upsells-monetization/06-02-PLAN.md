---
phase: 06-upsells-monetization
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/actions/create-upsell-checkout.ts
  - src/components/upsells/VariantUpsellModal.tsx
  - src/app/generate/[orderId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "After swiping through all 3 variants, user sees a modal offering a 4th variant at reduced price (£4.99)"
    - "Modal appears after a 5-second delay once all 3 variants are viewed (not before)"
    - "Dismissing the modal prevents it from re-appearing for that order"
    - "Accepting the upsell redirects to Stripe Checkout for the discounted amount"
    - "Server Action validates pricing server-side and verifies order ownership before creating checkout session"
  artifacts:
    - path: "src/actions/create-upsell-checkout.ts"
      provides: "Server Action for authenticated +1 variant upsell checkout"
      exports: ["createUpsellCheckout"]
    - path: "src/components/upsells/VariantUpsellModal.tsx"
      provides: "Animated modal with pricing, savings badge, benefits list, accept/dismiss buttons"
      contains: "VariantUpsellModal"
    - path: "src/app/generate/[orderId]/page.tsx"
      provides: "Generation page with upsell modal trigger after viewing all 3 variants"
      contains: "VariantUpsellModal"
  key_links:
    - from: "src/app/generate/[orderId]/page.tsx"
      to: "src/components/upsells/VariantUpsellModal.tsx"
      via: "hasSwipedAll state triggers modal display"
      pattern: "hasSwipedAll.*VariantUpsellModal"
    - from: "src/components/upsells/VariantUpsellModal.tsx"
      to: "src/actions/create-upsell-checkout.ts"
      via: "handleAccept calls Server Action"
      pattern: "createUpsellCheckout"
    - from: "src/actions/create-upsell-checkout.ts"
      to: "src/lib/stripe.ts"
      via: "creates checkout session with upsell order type"
      pattern: "createCheckoutSession.*upsell"
---

<objective>
Implement the +1 variant upsell flow: a modal that appears after the user has swiped through all 3 base variants, offering a 4th variant at a reduced price with secure server-side checkout.

Purpose: PAY-04 requirement. Captures revenue from users who want more options, presented at peak engagement (after viewing all variants but before committing to a selection).

Output: Server Action for upsell checkout, animated upsell modal component, updated generation page with trigger logic.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-upsells-monetization/06-RESEARCH.md
@.planning/phases/06-upsells-monetization/06-01-SUMMARY.md
@src/app/generate/[orderId]/page.tsx
@src/components/generation/VariantSwiper.tsx
@src/lib/bundles/pricing.ts
@src/actions/checkout.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create upsell Server Action and modal component</name>
  <files>
    src/actions/create-upsell-checkout.ts
    src/components/upsells/VariantUpsellModal.tsx
  </files>
  <action>
    1. Create `src/actions/create-upsell-checkout.ts`:
       - 'use server' directive
       - Import createCheckoutSession from @/lib/stripe, createServerSupabaseClient from @/lib/supabase, UPSELL_PRICE and validateUpsellPrice from @/lib/bundles/pricing
       - Export async function createUpsellCheckout({ orderId }: { orderId: string }): Promise<{ url: string }>
       - Get authenticated user via supabase.auth.getUser(), throw if not authenticated
       - Query order with song_variants to verify: (a) order exists, (b) user owns it (user_id match), (c) order doesn't already have 4+ variants (prevent duplicate upsells)
       - If any check fails, throw descriptive error
       - Call createCheckoutSession with: customizationId from order, userId, email, amount: UPSELL_PRICE, orderType: 'upsell', successUrl: /generate/{orderId}?upsell=success, cancelUrl: /generate/{orderId}?upsell=canceled, metadata: { originalOrderId: orderId, variantNumber: '4' }
       - Return { url: session.url }
       - Do NOT accept amount from client (use hardcoded UPSELL_PRICE to prevent manipulation)

    2. Create `src/components/upsells/VariantUpsellModal.tsx`:
       - 'use client' directive
       - Import motion, AnimatePresence from framer-motion, useState from react, createUpsellCheckout from @/actions/create-upsell-checkout
       - Import UPSELL_PRICE, BASE_PRICE from @/lib/bundles/pricing
       - Props: { orderId: string, isOpen: boolean, onClose: () => void }
       - Calculate savingsPercent from BASE_PRICE and UPSELL_PRICE: Math.round(((BASE_PRICE - UPSELL_PRICE) / BASE_PRICE) * 100)
       - Local state: isLoading (boolean)
       - handleAccept: set loading, call createUpsellCheckout({ orderId }), redirect to returned URL with window.location.href. On error: console.error and show alert.
       - AnimatePresence wrapping backdrop (black/50 overlay, click to close) and modal (scale/opacity/y animation)
       - Modal content: headline "Want One More Option?", subheadline about 4th variant, pricing card with purple-to-pink gradient bg (original price crossed out, discounted price large, savings badge), benefit list (3 items with green checkmarks: additional variant, same quality, generated in 30-60 seconds), CTA button "Yes, Generate 4th Variant" with purple-to-pink gradient, dismiss button "No Thanks, Continue with 3" with border style, trust signal text about offer expiring when variant selected
       - Format prices as GBP: £{(price / 100).toFixed(2)}
       - Match app theme: purple-to-pink gradients, rounded-2xl, shadow-2xl
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm TypeScript compiles.
    Verify Server Action does NOT accept amount parameter (uses UPSELL_PRICE constant).
    Verify modal uses AnimatePresence for mount/unmount animations.
    Verify modal has both accept and dismiss buttons.
  </verify>
  <done>
    Server Action securely creates upsell checkout with hardcoded pricing. Modal displays animated upsell offer with pricing, savings, and benefits.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate upsell modal trigger into generation page</name>
  <files>
    src/app/generate/[orderId]/page.tsx
  </files>
  <action>
    1. Modify `src/app/generate/[orderId]/page.tsx`:
       - Import VariantUpsellModal from @/components/upsells/VariantUpsellModal
       - Add state variables: hasSwipedAll (boolean, false), showUpsellModal (boolean, false), upsellDismissed (boolean, false)
       - Add handler function handleVariantIndexChange(index: number, total: number): when index === total - 1 and !hasSwipedAll, set hasSwipedAll = true
       - Pass onIndexChange callback to VariantSwiper component (this may require adding the prop to VariantSwiper -- check if it exists, add if needed)
       - Add useEffect: when hasSwipedAll is true and !upsellDismissed, start a 5-second setTimeout that sets showUpsellModal = true. Clean up timeout on unmount. Dependency array: [hasSwipedAll, upsellDismissed]
       - handleCloseUpsell: set showUpsellModal = false, set upsellDismissed = true
       - Render VariantUpsellModal with orderId={params.orderId}, isOpen={showUpsellModal}, onClose={handleCloseUpsell}
       - If VariantSwiper doesn't have an onIndexChange prop, add it: accept optional onIndexChange?: (index: number, total: number) => void prop, call it inside the navigation handler when currentIndex changes. Modify src/components/generation/VariantSwiper.tsx to support this.
       - Check for upsell=success in searchParams -- if present, show a brief toast or notification that 4th variant is being generated (use existing React Query polling to pick up the new variant)
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm TypeScript compiles.
    Verify generation page imports and renders VariantUpsellModal.
    Verify 5-second delay timer in useEffect.
    Verify upsellDismissed flag prevents modal from re-appearing.
    Verify VariantSwiper has onIndexChange callback.
  </verify>
  <done>
    Generation page triggers upsell modal after user views all 3 variants (5-second delay). Modal dismissal is persistent for the session. Accepting redirects to Stripe Checkout. Returning from successful upsell shows generation in progress for 4th variant.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. Server Action uses hardcoded UPSELL_PRICE (not client-provided amount)
3. Server Action verifies auth, order ownership, and prevents duplicate upsells (< 4 variants)
4. Modal uses Framer Motion AnimatePresence for smooth mount/unmount
5. Modal shows crossed-out original price and discounted price with savings percentage
6. 5-second delay after viewing all 3 variants before modal appears
7. Dismiss flag prevents modal from re-showing for same order
8. VariantSwiper communicates current index to parent via callback
</verification>

<success_criteria>
- Upsell modal appears 5 seconds after user swipes through all 3 base variants
- Modal shows £4.99 discounted price (37% off £7.99) with savings badge
- Accepting creates Stripe Checkout session and redirects
- Dismissing hides modal permanently for that session
- Server Action rejects requests if order already has 4+ variants
- No client-side price calculation (server hardcodes UPSELL_PRICE)
</success_criteria>

<output>
After completion, create `.planning/phases/06-upsells-monetization/06-02-SUMMARY.md`
</output>
